<!DOCTYPE html>
<!-- 
LOCAL DEVELOPMENT TOOL ONLY
This page is for quick local visualization of aggregated, non-PHI metrics
exported from your warehouse (CSV). Do not deploy publicly.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tuva Terminology Metrics</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1f2937; margin: 0; padding: 24px; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); overflow: hidden; }
    .header { background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%); color: #fff; padding: 32px 40px; display: flex; align-items: center; gap: 16px; }
    .header img { height: 32px; }
    .header h1 { font-size: 1.8rem; margin: 0; }
    .content { padding: 24px 40px 40px; }
    .upload { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
    .upload:hover { border-color: #2563eb; background: #eff6ff; }
    .upload.dragover { border-color: #1d4ed8; background: #dbeafe; }
    .controls { display: flex; gap: 12px; margin: 20px 0; flex-wrap: wrap; align-items: center; }
    select, button { padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff; }
    button.primary { background: #2563eb; color: #fff; border: none; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #e5e7eb; font-size: 0.95rem; }
    .table th { font-weight: 600; color: #374151; background: #f9fafb; position: sticky; top: 0; z-index: 1; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; }
    .badge.pass { background: #dcfce7; color: #166534; }
    .badge.fail { background: #fee2e2; color: #991b1b; }
    .percent-bar { background: #e5e7eb; height: 10px; border-radius: 9999px; overflow: hidden; }
    .percent-fill { height: 100%; background: #16a34a; }
    .percent-text { font-weight: 600; color: #111827; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
    .footer { margin-top: 24px; color: #6b7280; font-size: 0.85rem; text-align: center; }
  </style>
  <script>
    let metrics = [];
    let filtered = [];

    function byId(id) { return document.getElementById(id); }

    function handleDragOver(e) { e.preventDefault(); byId('drop').classList.add('dragover'); }
    function handleDragLeave(e) { e.preventDefault(); byId('drop').classList.remove('dragover'); }
    function handleDrop(e) {
      e.preventDefault(); byId('drop').classList.remove('dragover');
      const files = e.dataTransfer.files; if (files && files[0]) readFile(files[0]);
    }
    function handlePick() { byId('file').click(); }
    function handleFile(e) { const f = e.target.files[0]; if (f) readFile(f); }

    function readFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => { try { loadCSV(e.target.result); } catch (err) { alert('Error parsing CSV: ' + err.message); } };
      reader.readAsText(file);
    }

    function loadCSV(csvText) {
      metrics = parseCSV(csvText);
      populateMetricSelector();
      render();
    }

    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      if (!lines.length) return [];
      const headers = parseCSVLine(lines[0]).map(h => h.replace(/\"/g, '"').replace(/"/g, '').trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i]; if (!line.trim()) continue;
        const values = parseCSVLine(line).map(v => v.replace(/\"/g, '"').replace(/"/g, '').trim());
        const row = {};
        headers.forEach((h, idx) => row[h] = values[idx] ?? '');

        // Coerce numeric/boolean fields
        ['denominator_n','valid_n','invalid_n','null_n','multiple_n'].forEach(k => { if (row[k] !== '') row[k] = Number(row[k]); });
        if (row['valid_pct'] !== '') row['valid_pct'] = Number(row['valid_pct']);
        if (row['threshold'] !== '') row['threshold'] = Number(row['threshold']);
        if (typeof row['pass_flag'] === 'string') row['pass_flag'] = row['pass_flag'].toLowerCase() === 'true' || row['pass_flag'] === '1';

        rows.push(row);
      }
      return rows;
    }

    function parseCSVLine(line) {
      const result = []; let current = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i]; const next = i + 1 < line.length ? line[i+1] : '';
        if (ch === '"') {
          if (inQuotes && next === '"') { current += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          result.push(current); current = '';
        } else { current += ch; }
      }
      result.push(current);
      return result;
    }

    function populateMetricSelector() {
      const sel = byId('metric');
      sel.innerHTML = '';
      const unique = Array.from(new Map(metrics.map(m => [m.metric_id, m])).values());
      unique.sort((a,b) => a.metric_name.localeCompare(b.metric_name));
      unique.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.metric_id; opt.textContent = `${m.metric_name} — ${m.claim_scope}`;
        sel.appendChild(opt);
      });
      if (unique.length) sel.value = unique[0].metric_id;
    }

    function render() {
      const metricId = byId('metric').value;
      const search = byId('search').value.toLowerCase();
      filtered = metrics.filter(m => m.metric_id === metricId && (!search || (m.data_source||'').toLowerCase().includes(search)));
      // sort poorest first
      filtered.sort((a,b) => (a.valid_pct ?? 0) - (b.valid_pct ?? 0));
      renderTable();
    }

    function fmtPct(x) { if (x === null || x === undefined) return '—'; return (x*100).toFixed(1) + '%'; }

    function renderTable() {
      const tbody = byId('tbody');
      tbody.innerHTML = '';
      filtered.forEach(row => {
        const tr = document.createElement('tr');

        const tdDs = document.createElement('td'); tdDs.textContent = row.data_source || '—'; tr.appendChild(tdDs);

        const tdPct = document.createElement('td');
        const pctWrap = document.createElement('div'); pctWrap.style.display = 'flex'; pctWrap.style.alignItems = 'center'; pctWrap.style.gap = '8px';
        const pctText = document.createElement('span'); pctText.className = 'percent-text'; pctText.textContent = fmtPct(row.valid_pct);
        const bar = document.createElement('div'); bar.className = 'percent-bar'; bar.style.width = '180px';
        const fill = document.createElement('div'); fill.className = 'percent-fill'; fill.style.width = ((row.valid_pct||0)*100) + '%';
        // color based on threshold
        const thr = typeof row.threshold === 'number' ? row.threshold : null;
        const pass = thr !== null ? (row.valid_pct ?? 0) >= thr : true;
        fill.style.background = pass ? '#16a34a' : '#dc2626';
        bar.appendChild(fill);
        pctWrap.appendChild(pctText); pctWrap.appendChild(bar);
        tdPct.appendChild(pctWrap); tr.appendChild(tdPct);

        const tdDen = document.createElement('td'); tdDen.textContent = row.denominator_n ?? 0; tr.appendChild(tdDen);
        const tdValid = document.createElement('td'); tdValid.textContent = row.valid_n ?? 0; tr.appendChild(tdValid);
        const tdInvalid = document.createElement('td'); tdInvalid.textContent = row.invalid_n ?? 0; tr.appendChild(tdInvalid);
        const tdNull = document.createElement('td'); tdNull.textContent = row.null_n ?? 0; tr.appendChild(tdNull);
        const tdMult = document.createElement('td'); tdMult.textContent = row.multiple_n ?? 0; tr.appendChild(tdMult);

        const tdThr = document.createElement('td'); tdThr.textContent = thr !== null ? fmtPct(thr) : '—'; tr.appendChild(tdThr);

        const tdPass = document.createElement('td');
        const badge = document.createElement('span'); badge.className = 'badge ' + ((row.pass_flag ?? true) ? 'pass' : 'fail');
        badge.textContent = (row.pass_flag ?? true) ? 'PASS' : 'FAIL';
        tdPass.appendChild(badge); tr.appendChild(tdPass);

        tbody.appendChild(tr);
      });
    }

    function loadSample() {
      const sample = `"data_source","metric_id","metric_name","claim_scope","denominator_n","valid_n","invalid_n","null_n","multiple_n","valid_pct","threshold","pass_flag","denominator_desc","tuva_last_run"\n"payer_a","claims:institutional_inpatient:DRG_CODE","DRG Code (Inpatient)","institutional_inpatient",12000,11856,96,48,0,0.988,0.97,TRUE,"Institutional inpatient claims","2024-10-08"\n"payer_b","claims:institutional:REVENUE_CENTER_CODE","Revenue Center Code (Institutional)","institutional",500000,498000,1000,1000,0,0.996,0.97,TRUE,"Institutional claim lines","2024-10-08"\n"payer_a","claims:institutional:BILL_TYPE_CODE","Bill Type Code (Institutional)","institutional",14000,13720,200,60,20,0.980,0.97,TRUE,"Institutional claims","2024-10-08"\n"payer_a","claims:professional:HCPCS_CODE","HCPCS Code (Professional)","professional",800000,792000,6000,2000,0,0.990,0.97,TRUE,"Professional claim lines","2024-10-08"\n"payer_a","claims:institutional_outpatient:HCPCS_CODE","HCPCS Code (Institutional Outpatient)","institutional_outpatient",220000,185000,18000,17000,0,0.841,0.80,TRUE,"Institutional outpatient claim lines","2024-10-08"`;
      loadCSV(sample);
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="assets/tuva_logo.png" alt="Tuva" />
      <h1>Terminology Metrics</h1>
    </div>
    <div class="content">
      <div id="drop" class="upload" onclick="handlePick()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
        <div style="font-weight:600;">Drop CSV here or click to choose</div>
        <div style="color:#64748b; font-size:0.95rem;">Expected columns: data_source, metric_id, metric_name, claim_scope, denominator_n, valid_n, invalid_n, null_n, multiple_n, valid_pct, threshold, pass_flag</div>
        <input id="file" type="file" accept=".csv" style="display:none" onchange="handleFile(event)" />
      </div>

      <div class="controls">
        <label>Metric</label>
        <select id="metric" onchange="render()"></select>
        <label>Search data_source</label>
        <input id="search" placeholder="e.g. payer_a" oninput="render()" style="padding:10px 12px; border:1px solid #cbd5e1; border-radius:8px;" />
        <button class="primary" onclick="loadSample()">Load Sample Data</button>
      </div>

      <div class="grid">
        <div style="overflow:auto; max-height: 60vh; border:1px solid #e5e7eb; border-radius: 8px;">
          <table class="table">
            <thead>
              <tr>
                <th>data_source</th>
                <th>valid %</th>
                <th>denominator</th>
                <th>valid</th>
                <th>invalid</th>
                <th>null</th>
                <th>multiple</th>
                <th>threshold</th>
                <th>status</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer">No PHI leaves the warehouse: export an aggregated CSV of metrics from your database and load it here.</div>
    </div>
  </div>
</body>
</html>

