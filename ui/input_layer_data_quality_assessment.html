<!DOCTYPE html>
<!-- 
⚠️ LOCAL DEVELOPMENT TOOL ONLY ⚠️
This tool has known XSS vulnerabilities and should NEVER be:
- Deployed to any server (internal or external)
- Used with untrusted JSON files
- Converted to a web service
Only use with JSON files you generated yourself from dbt.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuva Data Quality Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 0 40px;
        }

        .header {
            background: linear-gradient(135deg, #2b6cb0 0%, #1a365d 100%);
            color: white;
            padding: 50px 0;
            margin: 0 -40px 60px -40px;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            max-width: 1120px;
            margin: 0 auto;
            padding: 0 40px;
        }
        .back { position:absolute; right:20px; top:20px; z-index:3; color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,0.6); padding:6px 10px; border-radius:8px; font-size:0.9rem; }
        .back:hover { background: rgba(255,255,255,0.15); }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 100px;
            height: 200%;
            background: linear-gradient(45deg, #fbbf24 0%, #f59e0b 100%);
            transform: rotate(15deg);
            opacity: 0.2;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -30%;
            right: 5%;
            width: 60px;
            height: 160%;
            background: linear-gradient(45deg, #60a5fa 0%, #3b82f6 100%);
            transform: rotate(-10deg);
            opacity: 0.3;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }

        .header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 30px;
            width: auto;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 2;
        }

        .instructions {
            background: transparent;
            border: none;
            border-radius: 0;
            margin: 0 0 50px 0;
            overflow: visible;
            box-shadow: none;
        }

        .instructions-header {
            padding: 20px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            color: #1e293b;
            transition: all 0.3s ease;
            border-bottom: 2px solid #e2e8f0;
        }

        .instructions-header:hover {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .instructions-title {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions-content {
            display: none;
            padding: 30px 0;
            color: #475569;
        }

        .instructions-content.open {
            display: block;
        }

        .instructions-content ol {
            color: #475569;
            margin-left: 24px;
            line-height: 1.7;
            font-size: 1rem;
        }

        .instructions-content li {
            margin-bottom: 8px;
        }

        .instructions-content code {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .instructions-toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        .instructions-toggle-arrow.open {
            transform: rotate(180deg);
        }

        .help-section {
            background: transparent;
            border: none;
            border-radius: 0;
            margin: 0 0 50px 0;
            overflow: visible;
            box-shadow: none;
        }

        .help-header {
            padding: 20px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            color: #1e293b;
            transition: all 0.3s ease;
            border-bottom: 2px solid #e2e8f0;
        }

        .help-header:hover {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .help-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-content {
            display: none;
            padding: 30px 0;
            color: #475569;
        }

        .help-content.open {
            display: block;
        }

        .help-content h4 {
            color: #1e293b;
            margin-bottom: 18px;
            font-weight: 700;
            font-size: 1.15rem;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .help-content h4:first-child {
            margin-top: 0;
        }

        .help-content ul {
            margin-left: 20px;
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .help-content li {
            margin-bottom: 8px;
        }

        .help-content strong {
            color: #1e293b;
            font-weight: 600;
        }

        .help-toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        .help-toggle-arrow.open {
            transform: rotate(180deg);
        }

        .upload-area {
            margin: 0 0 60px 0;
            padding: 60px 40px;
            border: 2px dashed #cbd5e0;
            border-radius: 24px;
            text-align: center;
            background: transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: none;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #2563eb;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #a0aec0;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #718096;
            font-size: 0.9rem;
        }

        .dashboard {
            display: none;
            padding: 0 0 40px 0;
        }

        .refresh-area {
            background: transparent;
            border: 2px dashed #06b6d4;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
        }

        .refresh-area:hover {
            background: linear-gradient(135deg, #cffafe 0%, #a7f3d0 100%);
            border-color: #0891b2;
            transform: translateY(-1px);
        }

        .refresh-area.dragover {
            background: linear-gradient(135deg, #a7f3d0 0%, #86efac 100%);
            border-color: #059669;
            transform: scale(1.02);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: transparent;
            padding: 24px 12px;
            border-radius: 0;
            box-shadow: none;
            border: none;
            transition: all 0.3s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: #cbd5e1;
            border-radius: 2px;
        }

        .stat-card.success::after {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .stat-card.error::after {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-card.warning::after {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .section {
            margin-bottom: 70px;
        }

        .section-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 30px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Enhanced Grade Display */
        .grade-container {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            margin-bottom: 60px;
            box-shadow: none;
        }

        .grade-container h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .grade-content {
            display: flex;
            align-items: center;
            gap: 30px;
            justify-content: center;
        }

        .grade-badge-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .grade-badge {
            display: inline-block;
            padding: 20px 30px;
            border-radius: 50%;
            font-weight: 900;
            font-size: 2.5rem;
            min-width: 80px;
            min-height: 80px;
            text-align: center;
            margin-bottom: 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grade-a {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        .grade-b {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.3);
        }
        .grade-c {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }
        .grade-d {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }
        .grade-f {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
        }

        .grade-description {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            font-size: 1.1rem;
            font-weight: 500;
            color: #475569;
            line-height: 1.6;
            flex: 1;
            max-width: 500px;
            box-shadow: none;
        }

        .grade-description.grade-a-desc {
            color: #059669;
        }

        .grade-description.grade-b-desc {
            color: #047857;
        }

        .grade-description.grade-c-desc {
            color: #d97706;
        }

        .grade-description.grade-d-desc {
            color: #dc2626;
        }

        .grade-description.grade-f-desc {
            color: #991b1b;
        }

        .severity-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 800;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .severity-1 {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .severity-2 {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            color: #9a3412;
            border: 1px solid #fdba74;
        }
        .severity-3 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .severity-4 {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            color: #5b21b6;
            border: 1px solid #c4b5fd;
        }
        .severity-5 {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
            border: 1px solid #c7d2fe;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 40px 60px;
            margin-bottom: 40px;
        }

        .group-card {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            transition: all 0.3s ease;
            box-shadow: none;
            position: relative;
        }

        .group-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .group-card-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .group-card-text.success-color {
            color: #059669;
            font-weight: 700;
        }

        .group-card-text.warning-color {
            color: #d97706;
            font-weight: 700;
        }

        .group-card-text.error-color {
            color: #dc2626;
            font-weight: 700;
        }

        .group-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .group-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .group-card-count {
            font-size: 0.9rem;
            color: #64748b;
            background: transparent;
            padding: 0;
            border-radius: 0;
            font-weight: 500;
        }

        .group-card-status {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .group-card-icon {
            font-size: 1.5rem;
        }

        .group-card-text {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .test-item {
            background: transparent;
            border: none;
            border-radius: 0;
            margin-bottom: 32px;
            overflow: visible;
            transition: all 0.3s ease;
            box-shadow: none;
            position: relative;
            border-bottom: 1px solid #e2e8f0;
        }

        .test-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }


        .test-status.warning {
            color: #d97706;
            font-weight: 700;
        }

        .test-header {
            padding: 24px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .test-info {
            flex: 1;
            min-width: 0;
            margin-right: 15px;
        }

        .test-name {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: 1.1rem;
        }

        .test-model {
            color: #64748b;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            flex-shrink: 0;
            min-width: 120px;
            justify-content: flex-end;
        }

        .test-status.failed {
            color: #dc2626;
            font-weight: 700;
        }

        .test-status.passed {
            color: #059669;
            font-weight: 700;
        }

        .test-details {
            display: none;
            padding: 20px 0 30px 0;
            border-top: 1px solid #e2e8f0;
            background: transparent;
            margin-top: 15px;
        }

        .test-details.open {
            display: block;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .sql-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .test-docs {
            background: #edf2f7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .test-docs h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .test-docs p {
            color: #4a5568;
            line-height: 1.6;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
        }

        .toggle-arrow.open {
            transform: rotate(90deg);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .footer {
            background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 100%);
            color: white;
            padding: 40px 0;
            margin: 60px -40px 0 -40px;
            text-align: center;
            border-top: 1px solid #e2e8f0;
        }

        .footer-inner {
            max-width: 1120px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .footer-logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .footer-logo {
            height: 40px;
            width: auto;
        }

        .footer-brand {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .footer-copyright {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a class="back" href="index.html">← Back</a>
            <div class="header-content">
                <h2><img src="assets/tuva_logo.png" alt="Tuva Logo" class="header-logo">TUVA Health</h2>
                <h1>Input Layer Data Quality Assessment</h1>
                <p>Assess the data quality of the input layer and how it will affect The Tuva Project.</p>
            </div>
        </div>

        <div class="instructions">
            <div class="instructions-header" onclick="toggleInstructions()">
                <div class="instructions-title">
                    <span>📋</span>
                    <span>How to Use This Application</span>
                </div>
                <span class="instructions-toggle-arrow" id="instructionsArrow">▼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
                <ol>
                    <li>Run your dbt tests: <code>dbt test</code></li>
                    <li>Locate your dbt project's <code>target/</code> folder</li>
                    <li>Drag and drop <code>run_results.json</code> and <code>manifest.json</code> files below</li>
                    <li>View detailed test results, failures, and model documentation</li>
                </ol>
            </div>
        </div>

        <div class="help-section">
            <div class="help-header" onclick="toggleHelp()">
                <div class="help-title">
                    <span>❓</span>
                    <span>Understanding Grades & Severity Levels</span>
                </div>
                <span class="help-toggle-arrow" id="helpArrow">▼</span>
            </div>
            <div class="help-content" id="helpContent">
                <h4>Grades:</h4>
                <ul>
                    <li><strong>A (Excellent):</strong> No critical issues detected. Your data quality is outstanding with only informational warnings, if any.</li>
                    <li><strong>B (Good):</strong> All data marts are usable with minor issues that may require attention. Address level 4 issues when convenient.</li>
                    <li><strong>C (Fair):</strong> Some data marts require attention before use. Review and assess all open issues, particularly level 3 severity items.</li>
                    <li><strong>D (Poor):</strong> Some data marts may not be usable. Address all severity level 2 issues before proceeding with data analysis.</li>
                    <li><strong>F (Critical):</strong> Project may fail to build completely. All or most data marts are not usable. Immediate action required on level 1 issues.</li>
                </ul>

                <h4>Severity Levels:</h4>
                <ul>
                    <li><strong>Level 1:</strong> Critical issue that may prevent the entire project from building</li>
                    <li><strong>Level 2:</strong> Major issue affecting data reliability in data marts</li>
                    <li><strong>Level 3:</strong> Moderate issue requiring caution in data usage, specific to marts</li>
                    <li><strong>Level 4:</strong> Minor issues with limited impact, specific to marts</li>
                    <li><strong>Level 5:</strong> Low-priority issues / informational</li>
                </ul>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📁</div>
            <div class="upload-text">Drag & drop your dbt files here</div>
            <div class="upload-hint">Drop run_results.json and manifest.json from your target/ folder</div>
            <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
        </div>

        <div class="dashboard" id="dashboard">
            <div class="refresh-area" id="refreshArea">
                <div style="font-size: 1.1rem; font-weight: 600; color: #2c7a7b; margin-bottom: 5px;">
                    🔄 Update Results
                </div>
                <div style="color: #4a5568; font-size: 0.9rem;">
                    Drag & drop new run_results.json and manifest.json files to refresh the dashboard
                </div>
            </div>

            <div class="grade-container">
                <h3>Overall Data Quality Grade</h3>
                <div class="grade-content">
                    <div class="grade-badge-section">
                        <div id="overallGrade" class="grade-badge">
                            <!-- Grade will be populated here -->
                        </div>
                    </div>
                    <div id="gradeDescription" class="grade-description">
                        <!-- Grade description will be populated here -->
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    📊 Summary
                </div>
               <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated here -->
                </div>

                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 40px;">
                    <div style="flex: 1;">
                        <h3 style="font-size: 1.2rem; font-weight: 600; color: #1a202c; margin-bottom: 20px;">Issues by Severity Level</h3>
                        <div id="severityBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                            <!-- Severity breakdown will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    🎯 Data Mart Usability
                </div>
                <div id="qualityGroups">
                    <!-- Quality groups will be populated here -->
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    🚨 All Issues (Ordered by Severity)
                </div>
                <div id="allIssues">
                    <!-- All issues will be populated here -->
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-inner">
                <div class="footer-content">
                    <div class="footer-logo-section">
                        <img src="assets/tuva_logo_white.png" alt="Tuva Logo" class="footer-logo">
                    </div>
                    <div class="footer-copyright">
                        © 2024 Tuva Health. All rights reserved.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let runResults = null;
        let manifest = null;

        const uploadArea = document.getElementById('uploadArea');
        const refreshArea = document.getElementById('refreshArea');
        const fileInput = document.getElementById('fileInput');
        const dashboard = document.getElementById('dashboard');

        // File upload handling for both upload and refresh areas
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);

        refreshArea.addEventListener('click', () => fileInput.click());
        refreshArea.addEventListener('dragover', handleRefreshDragOver);
        refreshArea.addEventListener('dragleave', handleRefreshDragLeave);
        refreshArea.addEventListener('drop', handleRefreshDrop);

        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleRefreshDragOver(e) {
            e.preventDefault();
            refreshArea.classList.add('dragover');
        }

        function handleRefreshDragLeave(e) {
            e.preventDefault();
            refreshArea.classList.remove('dragover');
        }

        function handleRefreshDrop(e) {
            e.preventDefault();
            refreshArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                if (file.name.includes('run_results.json')) {
                    readJsonFile(file, (data) => {
                        runResults = data;
                        checkAndRender();
                    });
                } else if (file.name.includes('manifest.json')) {
                    readJsonFile(file, (data) => {
                        manifest = data;
                        checkAndRender();
                    });
                }
            });
        }

        function readJsonFile(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    callback(data);
                } catch (error) {
                    alert(`Error reading ${file.name}: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function checkAndRender() {
            if (runResults && manifest) {
                renderDashboard();
            }
        }

        function renderDashboard() {
            uploadArea.style.display = 'none';
            dashboard.style.display = 'block';

            const testResults = extractTestResults();
            renderStats(testResults);
            const overallGrade = calculateOverallGrade(testResults);
            renderSummaryChart(testResults, overallGrade);
            renderQualityGroups(testResults);
            renderAllIssues(testResults);
        }

        function extractTestResults() {
            const results = [];

            // Debug logging
            console.log('Total results in run_results:', runResults.results.length);

            // Check what resource types we actually have
            const resourceTypes = {};
            runResults.results.forEach(result => {
                resourceTypes[result.resource_type] = (resourceTypes[result.resource_type] || 0) + 1;
            });
            console.log('Resource types found:', resourceTypes);

            // Look for tests with different possible resource_type values
            const testResults = runResults.results.filter(r =>
                r.resource_type === 'test' ||
                r.resource_type === 'data_test' ||
                r.resource_type === 'schema_test' ||
                r.resource_type === 'generic_test' ||
                r.unique_id.includes('.test.') ||
                (r.unique_id.includes('test:') || r.unique_id.startsWith('test.'))
            );
            console.log('Test results found:', testResults.length);

            // Also check if we're missing the manifest for some reason
            if (!manifest || !manifest.nodes) {
                console.error('Manifest is missing or invalid');
                return results;
            }

            runResults.results.forEach(result => {
                // Cast a wider net for what might be a test
                const isTest = result.resource_type === 'test' ||
                              result.resource_type === 'data_test' ||
                              result.resource_type === 'schema_test' ||
                              result.resource_type === 'generic_test' ||
                              result.unique_id.includes('.test.') ||
                              (result.unique_id.includes('test:') || result.unique_id.startsWith('test.'));

                if (isTest) {
                    const testNode = manifest.nodes[result.unique_id];

                    if (!testNode) {
                        console.warn('Test node not found in manifest:', result.unique_id);
                        // Exclude all tests without manifest info since we can't determine severity
                        console.log('Excluding test without manifest:', result.unique_id, 'Status:', result.status);
                        return;
                    }

                    // Extract severity and groups from tags
                    const tags = testNode.tags || [];
                    const severity = getSeverityFromTags(tags);
                    const groups = getGroupsFromTags(tags);
                    
                    // Debug logging for severity extraction
                    if (result.status === 'fail' || result.status === 'warn') {
                        console.log('Test:', testNode.name, 'Tags:', tags, 'Severity:', severity, 'Status:', result.status);
                    }

                    const modelNode = testNode.depends_on?.nodes?.find(nodeId =>
                        manifest.nodes[nodeId] && manifest.nodes[nodeId].resource_type === 'model'
                    );

                    // Only include tests that have valid severity tags (regardless of pass/fail status)
                    const shouldInclude = severity !== null && severity !== undefined;
                    
                    if (shouldInclude) {
                        results.push({
                            unique_id: result.unique_id,
                            name: testNode.name || result.unique_id.split('.').pop(),
                            status: result.status,
                            message: result.message,
                            failures: result.failures,
                            execution_time: result.execution_time,
                            compiled_code: testNode.compiled_code,
                            raw_code: testNode.raw_code,
                            model_name: modelNode ? manifest.nodes[modelNode].name : 'Unknown',
                            model_path: modelNode ? manifest.nodes[modelNode].original_file_path : '',
                            test_description: testNode.description || '',
                            folder: testNode.original_file_path ? testNode.original_file_path.split('/').slice(0, -1).join('/') : 'root',
                            tags: tags,
                            severity: severity,
                            group: groups.length > 0 ? groups[0] : null,
                            groups: groups
                        });
                    } else {
                        console.log('Excluding test without valid severity:', testNode.name, 'Status:', result.status, 'Tags:', tags, 'Severity:', severity);
                    }
                }
            });

            console.log('Final processed results:', results.length);
            return results;
        }

        function getSeverityFromTags(tags) {
            if (tags.includes('tuva_dqi_sev_1')) return 1;
            if (tags.includes('tuva_dqi_sev_2')) return 2;
            if (tags.includes('tuva_dqi_sev_3')) return 3;
            if (tags.includes('tuva_dqi_sev_4')) return 4;
            if (tags.includes('tuva_dqi_sev_5')) return 5;
            return null;
        }

        function getGroupsFromTags(tags) {
            const groups = [];

            if (tags.includes('dqi_ccsr')) groups.push('CCSR');
            if (tags.includes('dqi_cms_chronic_conditions')) groups.push('CMS Chronic Conditions');
            if (tags.includes('dqi_cms_hccs')) groups.push('CMS HCCs');
            if (tags.includes('dqi_ed_classification')) groups.push('ED Classification');
            if (tags.includes('dqi_financial_pmpm')) groups.push('Financial PMPM');
            if (tags.includes('dqi_quality_measures')) groups.push('Quality Measures');
            if (tags.includes('dqi_readmission')) groups.push('Readmission');
            if (tags.includes('dqi_service_categories')) groups.push('Service Categories');
            if (tags.includes('dqi_tuva_chronic_conditions')) groups.push('Tuva Chronic Conditions');

            return groups;
        }

        function getGroupStatus(tests) {
            // All tests already have valid severity tags due to filtering at extraction level
            const issues = tests.filter(t => t.status === 'fail' || t.status === 'warn');

            if (issues.length === 0) {
                return {
                    status: 'usable',
                    icon: '✅',
                    text: 'Usable',
                    class: 'success'
                };
            }

            // Check for severity 1-2 issues
            const hasSev1or2 = issues.some(t => t.severity === 1 || t.severity === 2);
            if (hasSev1or2) {
                return {
                    status: 'not-usable',
                    icon: '❌',
                    text: 'Not Usable',
                    class: 'error'
                };
            }

            // Check for severity 3 issues
            const hasSev3 = issues.some(t => t.severity === 3);
            if (hasSev3) {
                return {
                    status: 'caution',
                    icon: '⚠️',
                    text: 'Use with Caution',
                    class: 'warning'
                };
            }

            // Only severity 4-5 issues
            return {
                status: 'usable',
                icon: '✅',
                text: 'Usable',
                class: 'success'
            };
        }

        function renderQualityGroups(testResults) {
            const groups = {};

            // Initialize all possible groups
            const allGroupNames = ['CCSR', 'CMS Chronic Conditions', 'CMS HCCs', 'ED Classification',
                                 'Financial PMPM', 'Quality Measures', 'Readmission', 'Service Categories',
                                 'Tuva Chronic Conditions'];

            allGroupNames.forEach(groupName => {
                groups[groupName] = [];
            });

            // Add each test to all applicable groups (all tests already have valid severity tags)
            testResults.forEach(test => {
                if (test.groups && test.groups.length > 0) {
                    test.groups.forEach(groupName => {
                        if (groups[groupName]) {
                            groups[groupName].push(test);
                        }
                    });
                }
            });

            let html = '<div class="groups-grid">';

            // Only show groups that have tests
            Object.keys(groups).sort().forEach(groupName => {
                const tests = groups[groupName];
                if (tests.length === 0) return; // Skip empty groups

                const groupStatus = getGroupStatus(tests);

                html += `
                    <div class="group-card ${groupStatus.status}">
                        <div class="group-card-header">
                            <div>
                                <div class="group-card-title">${groupName}</div>
                                <div class="group-card-count">${tests.length} tests</div>
                            </div>
                            <div class="group-card-status">
                                <div class="group-card-icon">${groupStatus.icon}</div>
                                <div class="group-card-text ${groupStatus.class === 'success' ? 'success-color' : groupStatus.class === 'warning' ? 'warning-color' : 'error-color'}">
                                    ${groupStatus.text}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('qualityGroups').innerHTML = html;
        }

        function renderStats(testResults) {
            // All tests in testResults already have valid severity tags due to filtering at extraction level
            const passed = testResults.filter(t => t.status === 'pass').length;
            const failed = testResults.filter(t => t.status === 'fail').length;
            const warnings = testResults.filter(t => t.status === 'warn').length;
            const total = testResults.length;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-number">${passed}</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-number">${failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number">${warnings}</div>
                    <div class="stat-label">Warnings</div>
                </div>
            `;
        }

        function calculateOverallGrade(testResults) {
            // All tests in testResults already have valid severity tags due to filtering at extraction level
            const issues = testResults.filter(t => t.status === 'fail' || t.status === 'warn');

            if (issues.length === 0) return 'A';

            // Debug logging
            console.log('Issues with valid severity:', issues.length);
            console.log('Issues with severity info:', issues.map(t => ({ name: t.name, severity: t.severity, status: t.status })));

            const hasLevel1 = issues.some(t => t.severity === 1);
            const hasLevel2 = issues.some(t => t.severity === 2);
            const hasLevel3 = issues.some(t => t.severity === 3);
            const hasLevel4 = issues.some(t => t.severity === 4);

            console.log('Severity levels found:', { level1: hasLevel1, level2: hasLevel2, level3: hasLevel3, level4: hasLevel4 });

            // Grade based on highest severity level present
            if (hasLevel1) return 'F';  // Has severity level 1 issues
            if (hasLevel2) return 'D';  // Has severity level 2 issues but no level 1
            if (hasLevel3) return 'C';  // Has severity level 3 issues but no level 1-2
            if (hasLevel4) return 'B';  // Has severity level 4 issues but no level 1-3

            return 'A';  // No severity level 1-4 issues detected
        }

        function renderSummaryChart(testResults, overallGrade) {
            // All tests in testResults already have valid severity tags due to filtering at extraction level
            const issues = testResults.filter(t => t.status === 'fail' || t.status === 'warn');
            const severityCounts = {
                1: 0, 2: 0, 3: 0, 4: 0, 5: 0
            };

            issues.forEach(test => {
                severityCounts[test.severity]++;
            });

            // Render severity breakdown
            const severityHtml = `
                <div class="stat-card error">
                    <div class="stat-number">${severityCounts[1]}</div>
                    <div class="stat-label">Level 1</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-number">${severityCounts[2]}</div>
                    <div class="stat-label">Level 2</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number">${severityCounts[3]}</div>
                    <div class="stat-label">Level 3</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number">${severityCounts[4]}</div>
                    <div class="stat-label">Level 4</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${severityCounts[5]}</div>
                    <div class="stat-label">Level 5</div>
                </div>
            `;

            document.getElementById('severityBreakdown').innerHTML = severityHtml;

            // Get grade description
            const gradeDescriptions = {
                'A': 'Excellent - No critical issues detected. Your data quality is outstanding with only informational warnings, if any.',
                'B': 'Good - All data marts are usable with minor issues that may require attention. Address level 4 issues when convenient.',
                'C': 'Fair - Some data marts require attention before use. Review and assess all open issues, particularly level 3 severity items.',
                'D': 'Poor - Some data marts may not be usable. Address all severity level 2 issues before proceeding with data analysis.',
                'F': 'Critical - Project may fail to build completely. All or most data marts are not usable. Immediate action required on level 1 issues.'
            };

            // Render the overall grade
            const gradeElement = document.getElementById('overallGrade');
            gradeElement.textContent = overallGrade;
            gradeElement.className = `grade-badge grade-${overallGrade.toLowerCase()}`;

            // Render the grade description with appropriate styling
            const gradeDescriptionElement = document.getElementById('gradeDescription');
            gradeDescriptionElement.textContent = gradeDescriptions[overallGrade] || '';
            gradeDescriptionElement.className = `grade-description grade-${overallGrade.toLowerCase()}-desc`;
        }

        function renderAllIssues(testResults) {
            // All tests in testResults already have valid severity tags due to filtering at extraction level
            const issues = testResults.filter(t => t.status === 'fail' || t.status === 'warn');

            if (issues.length === 0) {
                document.getElementById('allIssues').innerHTML = '<div class="empty-state">🎉 No issues found! All tests with valid severity tags are passing.</div>';
                return;
            }

            // Sort by severity (1 = highest priority, 5 = lowest priority)
            issues.sort((a, b) => {
                // Sort by severity (ascending - 1 is most critical)
                if (a.severity !== b.severity) {
                    return a.severity - b.severity;
                }

                // If same severity, sort by status (fail before warn)
                if (a.status !== b.status) {
                    return a.status === 'fail' ? -1 : 1;
                }

                // Finally sort by name
                return a.name.localeCompare(b.name);
            });

            let html = '';
            issues.forEach(test => {
                html += renderTestItem(test);
            });

            document.getElementById('allIssues').innerHTML = html;
        }

        function renderTestItem(test) {
            let statusIcon, statusClass;

            if (test.status === 'pass') {
                statusIcon = '✅';
                statusClass = 'passed';
            } else if (test.status === 'warn') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'failed';
            }

            const severityBadge = test.severity ? `<span class="severity-badge severity-${test.severity}">Level ${test.severity}</span>` : '';
            const groupsText = test.groups && test.groups.length > 0 ? test.groups.join(', ') : 'None';

            return `
                <div class="test-item ${statusClass}">
                    <div class="test-header" onclick="toggleTestDetails('${test.unique_id}')">
                        <div class="test-info">
                            <div class="test-name">${severityBadge} ${test.name}</div>
                            <div class="test-model">Model: ${test.model_name} | Groups: ${groupsText}</div>
                        </div>
                        <div class="test-status ${statusClass}">
                            ${statusIcon} ${test.status.toUpperCase()}
                            <span class="toggle-arrow" id="arrow-${test.unique_id}">▶</span>
                        </div>
                    </div>
                    <div class="test-details" id="details-${test.unique_id}">
                        ${(test.status === 'fail' || test.status === 'warn') && test.message ? `
                            <div class="error-message">${test.message}</div>
                        ` : ''}
                        ${test.test_description ? `
                            <div class="test-docs">
                                <h4>Test Description</h4>
                                <p>${test.test_description}</p>
                            </div>
                        ` : ''}
                        ${test.compiled_code ? `
                            <h4>Test SQL</h4>
                            <div class="sql-code">${test.compiled_code}</div>
                        ` : ''}
                        ${test.tags && test.tags.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Tags:</strong> ${test.tags.join(', ')}
                            </div>
                        ` : ''}
                        <div style="margin-top: 10px; color: #718096; font-size: 0.9rem;">
                            Execution time: ${test.execution_time ? test.execution_time.toFixed(3) : 'N/A'}s
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleTestDetails(testId) {
            const details = document.getElementById(`details-${testId}`);
            const arrow = document.getElementById(`arrow-${testId}`);

            if (details.classList.contains('open')) {
                details.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                details.classList.add('open');
                arrow.classList.add('open');
            }
        }

        function toggleHelp() {
            const content = document.getElementById('helpContent');
            const arrow = document.getElementById('helpArrow');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                content.classList.add('open');
                arrow.classList.add('open');
            }
        }

        function toggleInstructions() {
            const content = document.getElementById('instructionsContent');
            const arrow = document.getElementById('instructionsArrow');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                content.classList.add('open');
                arrow.classList.add('open');
            }
        }
    </script>
</body>
</html>
