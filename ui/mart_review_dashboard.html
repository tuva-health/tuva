<!DOCTYPE html>
<!-- 
LOCAL DEVELOPMENT TOOL ONLY
This page visualizes aggregated, non-PHI metrics from the mart_review area.
Export small, aggregated CSVs from your warehouse and load them here.
Do not deploy publicly.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tuva Mart Review Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    :root { --bg:#f8fafc; --text:#1f2937; --card:#fff; --muted:#64748b; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --bad:#dc2626; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); margin:0; padding:24px; }
    .container { max-width: 1600px; margin: 0 auto; background: var(--card); border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); overflow: hidden; }
    .header { background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%); color:#fff; padding: 28px 36px; display:flex; align-items:center; gap:14px; justify-content:space-between; }
    .header img { height: 30px; }
    .header h1 { font-size: 1.6rem; margin:0; }
    .header .left { display:flex; align-items:center; gap:14px; }
    .header .back { margin-left:auto; color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,0.6); padding:6px 10px; border-radius:8px; font-size:0.9rem; }
    .header .back:hover { background: rgba(255,255,255,0.15); }
    .content { padding: 18px 22px 28px; }
    .upload { border:2px dashed #cbd5e1; border-radius:12px; padding: 18px; text-align:center; cursor:pointer; transition: all 0.2s ease; }
    .upload:hover { border-color: var(--brand); background:#eff6ff; }
    .upload.dragover { border-color:#1d4ed8; background:#dbeafe; }
    .small { color: var(--muted); font-size: 0.92rem; }
    .error { background:#fee2e2; border:1px solid #ef4444; color:#991b1b; padding:10px 12px; border-radius:8px; margin-top:10px; display:none; }
    .info { background:#eff6ff; border:1px solid #3b82f6; color:#1e40af; padding:10px 12px; border-radius:8px; margin-top:10px; display:none; }
    .controls { display:flex; gap:12px; margin: 14px 0; align-items:center; flex-wrap: wrap; }
    input, select, button { padding: 8px 10px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; }
    button.primary { background: var(--brand); color:#fff; border:none; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 20px; }
    .section { border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff; }
    .section h2 { font-size:1.1rem; margin:0 0 6px; }
    .section p { margin: 4px 0 10px; color: var(--muted); }
    .stat-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .stat { background:#f9fafb; border:1px solid var(--line); border-radius:10px; padding:12px; }
    .stat .label { font-size: 0.85rem; color: var(--muted); }
    .stat .value { font-size: 1.4rem; font-weight: 700; }
    .chart { height: 280px; }
    .two-col { display:grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap:14px; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { text-align:left; padding:8px 8px; border-bottom:1px solid var(--line); font-size:0.92rem; }
    details { margin-top:8px; }
    code.sql { display:block; white-space: pre-wrap; background:#0b1020; color:#cfe7ff; padding:10px; border-radius:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; font-size:0.82rem; }
    .footer { margin-top: 20px; color:#6b7280; font-size:0.88rem; text-align:center; }
    /* Tabs */
    .tabs { display:flex; gap:8px; border-bottom:1px solid var(--line); margin:12px 0 16px; flex-wrap:wrap; }
    .tabs button { background:#f8fafc; border:1px solid var(--line); border-bottom:none; border-radius:8px 8px 0 0; padding:8px 12px; cursor:pointer; color:#334155; }
    .tabs button.active { background:#fff; color:#111827; border-color:#cbd5e1; }
    .tab-pane { display:none; }
    .tab-pane.active { display:block; }
    .muted { color: var(--muted); font-size: 0.9rem; }
    .nowrap { white-space: nowrap; }
    .toggle { display:inline-flex; align-items:center; gap:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="left">
        <img src="assets/tuva_logo.png" alt="Tuva" />
        <h1>Mart Review Dashboard</h1>
      </div>
      <a class="back" href="index.html">← Back</a>
    </div>
    <div class="content">
      <div id="drop" class="upload" onclick="pickFiles()" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFiles(event)">
        <div style="font-weight:600;">Drop aggregated CSVs here or click to choose</div>
        <div class="small">Accepted datasets are aggregated exports from the `data_quality` mart_review views (no PHI). You can load multiple files (age, gender, PMPM, claims/enrollment, conditions, inpatient, ED, service categories, HCC, pharmacy).</div>
        <input id="file" type="file" accept=".csv" multiple style="display:none" />
      </div>
      <p class="small" style="margin-top:8px;">
        Tip: You can also export a single unified table that powers this dashboard: <code>data_quality.mart_review__dashboard_export</code>.
        Build it with <code>dbt run -s data_quality.dqi.mart_review.final.mart_review__dashboard_export</code> and load that one CSV here.
      </p>
      <div id="errorBox" class="error"></div>
      <div id="infoBox" class="info"></div>

      <div class="controls">
        <label>Schema Prefix</label>
        <input id="schemaPrefix" placeholder="e.g. dev_brad.data_quality" oninput="renderAll()" />
        <label>data_source</label>
        <select id="selDataSource" onchange="handleFilterChange()"></select>
        <label>payer</label>
        <select id="selPayer" onchange="handleFilterChange()"></select>
        <label>plan</label>
        <select id="selPlan" onchange="handleFilterChange()"></select>
        <button class="primary" onclick="loadSample()">Load Sample</button>
        <button onclick="clearAll()">Clear All</button>
      </div>

      <div class="tabs">
        <button class="active" data-tab="tab-pop">Population Overview</button>
        <button data-tab="tab-cond">Conditions & Risk</button>
        <button data-tab="tab-inpt">Inpatient</button>
        <button data-tab="tab-ed">Emergency Dept</button>
        <button data-tab="tab-svc">Services & Encounters</button>
        <button data-tab="tab-pharm">Pharmacy</button>
      </div>

      <div id="tab-pop" class="tab-pane active">
        <div class="section">
          <h2>Population Overview</h2>
          <p>Average age, gender distribution, and members by state.</p>
          <div class="stat-grid">
            <div class="stat"><div class="label">Average Age</div><div id="avgAge" class="value">—</div></div>
            <div class="stat"><div class="label">Population</div><div id="populationCount" class="value">—</div></div>
          </div>
          <div class="two-col">
            <div>
              <canvas id="chartAgeHist" class="chart"></canvas>
              <details>
                <summary>SQL template: Age distribution (aggregated)</summary>
                <code class="sql" id="sqlAge"></code>
              </details>
            </div>
            <div>
              <canvas id="chartGender" class="chart"></canvas>
              <details>
                <summary>SQL template: Gender distribution (aggregated)</summary>
                <code class="sql" id="sqlGender"></code>
              </details>
            </div>
          </div>
        </div>
        <div class="section">
          <h2>Members by State</h2>
          <p>Count of members by state (descending).</p>
          <div style="overflow:auto; max-height: 320px; border:1px solid var(--line); border-radius:10px;">
            <table class="table" id="tblState"><thead><tr>
              <th>state</th><th class="nowrap">members</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <details>
            <summary>SQL template: Members by state (aggregated)</summary>
            <code class="sql" id="sqlState"></code>
          </details>
        </div>
        <div class="section">
          <h2>Monthly Trends</h2>
          <p>PMPM, members with claims, and claims with enrollment by month.</p>
          <div class="two-col">
            <div>
              <canvas id="chartPmpm" class="chart"></canvas>
              <details>
                <summary>SQL template: PMPM by month (aggregated)</summary>
                <code class="sql" id="sqlPmpm"></code>
              </details>
            </div>
            <div>
              <canvas id="chartMembersClaims" class="chart"></canvas>
              <details>
                <summary>SQL template: Members with claims by month (aggregated)</summary>
                <code class="sql" id="sqlMembersClaims"></code>
              </details>
            </div>
          </div>
          <div>
            <canvas id="chartClaimsEnrollment" class="chart"></canvas>
            <details>
              <summary>SQL template: Claims with enrollment by month (aggregated)</summary>
              <code class="sql" id="sqlClaimsEnrollment"></code>
            </details>
          </div>
        </div>
      </div>

      <div id="tab-cond" class="tab-pane">
        <div class="section">
          <h2>Conditions & Risk</h2>
          <p>Chronic condition frequency and CMS-HCC code frequency.</p>
          <div class="two-col">
            <div>
              <canvas id="chartConditions" class="chart"></canvas>
              <details>
                <summary>SQL template: Chronic conditions (aggregated)</summary>
                <code class="sql" id="sqlConditions"></code>
              </details>
            </div>
            <div>
              <canvas id="chartHcc" class="chart"></canvas>
              <details>
                <summary>SQL template: HCC codes (aggregated)</summary>
                <code class="sql" id="sqlHcc"></code>
              </details>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-inpt" class="tab-pane">
        <div class="section">
          <h2>Inpatient</h2>
          <p>LOS distribution, DRG frequency, readmission rate, and discharge locations.</p>
          <div class="stat-grid">
            <div class="stat"><div class="label">Inpatient Encounters</div><div id="ipEncounters" class="value">—</div></div>
            <div class="stat"><div class="label">Readmission Rate</div><div id="ipReadmitRate" class="value">—</div></div>
            <div class="stat"><div class="label">Avg LOS</div><div id="ipAvgLos" class="value">—</div></div>
          </div>
          <div class="two-col">
            <div>
              <canvas id="chartInpatientLos" class="chart"></canvas>
              <details>
                <summary>SQL template: Inpatient LOS distribution (aggregated)</summary>
                <code class="sql" id="sqlInpatient"></code>
              </details>
            </div>
            <div>
              <canvas id="chartDrg" class="chart"></canvas>
              <details>
                <summary>SQL template: DRG frequency (aggregated)</summary>
                <code class="sql" id="sqlDrg"></code>
              </details>
            </div>
          </div>
          <div class="two-col">
            <div>
              <h3 class="small">Discharge Location by Facility</h3>
              <div style="overflow:auto; max-height: 280px; border:1px solid var(--line); border-radius:10px;">
                <table class="table" id="tblDischarge"><thead><tr>
                  <th>facility_id</th><th>discharge_location</th><th>count</th>
                </tr></thead><tbody></tbody></table>
              </div>
              <details>
                <summary>SQL template: Discharge location by facility (aggregated)</summary>
                <code class="sql" id="sqlDischarge"></code>
              </details>
            </div>
            <div>
              <h3 class="small">Readmission Rate (overall)</h3>
              <canvas id="chartReadmit" class="chart"></canvas>
              <details>
                <summary>SQL template: Readmission rate (aggregated)</summary>
                <code class="sql" id="sqlReadmit"></code>
              </details>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-ed" class="tab-pane">
        <div class="section">
          <h2>Emergency Department</h2>
          <p>ED spend by facility and avoidable categories by count and spend.</p>
          <div class="two-col">
            <div>
              <h3 class="small">ED Spend by Facility</h3>
              <div style="overflow:auto; max-height: 320px; border:1px solid var(--line); border-radius:10px;">
                <table class="table" id="tblEdFacility"><thead><tr>
                  <th>facility_id</th><th>spend</th>
                </tr></thead><tbody></tbody></table>
              </div>
              <details>
                <summary>SQL template: ED spend by facility (aggregated)</summary>
                <code class="sql" id="sqlEdFacility"></code>
              </details>
            </div>
            <div>
              <h3 class="small">Avoidable ED Category</h3>
              <canvas id="chartEd" class="chart"></canvas>
              <canvas id="chartEdSpend" class="chart" style="margin-top:10px;"></canvas>
              <details>
                <summary>SQL template: ED avoidable categories (aggregated)</summary>
                <code class="sql" id="sqlEd"></code>
              </details>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-svc" class="tab-pane">
        <div class="section">
          <h2>Service Categories</h2>
          <p>Paid amount and unique visits by category. Expand to view sub-categories.</p>
          <div style="overflow:auto; max-height: 380px; border:1px solid var(--line); border-radius:10px;">
            <table class="table" id="tblSvc"><thead><tr>
              <th>service_category_1</th><th>service_category_2</th><th>service_category_3</th><th>paid</th><th>visits</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <details>
            <summary>SQL template: Service categories (aggregated)</summary>
            <code class="sql" id="sqlSvc"></code>
          </details>
        </div>
        <div class="section">
          <h2>Encounter Groups</h2>
          <p>Distinct encounter count and paid by group; expand to type.</p>
          <div style="overflow:auto; max-height: 380px; border:1px solid var(--line); border-radius:10px;">
            <table class="table" id="tblEnc"><thead><tr>
              <th>encounter_group</th><th>encounter_type</th><th>encounters</th><th>paid</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <details>
            <summary>SQL template: Encounter group/type (aggregated)</summary>
            <code class="sql" id="sqlEncTypes"></code>
          </details>
        </div>
      </div>

      <div id="tab-pharm" class="tab-pane">
        <div class="section">
          <h2>Pharmacy</h2>
          <p>
            Pivot by therapeutic class and optionally NDC.
            <span class="muted">Performance tip: leave NDC off to keep tables lighter.</span>
          </p>
          <label class="toggle"><input type="checkbox" id="chkPharmNdc" onchange="renderPharmacy()" /> Include NDC detail</label>
          <div class="muted">Viewer only renders first 500 rows for readability.</div>
          <div style="overflow:auto; max-height: 360px; border:1px solid var(--line); border-radius:10px;">
            <table class="table" id="tblPharm"><thead><tr>
              <th>theraclass</th><th class="ndc-col">ndc_code</th><th class="ndc-col">ndc_description</th>
              <th>spend</th><th>avg_days_supply</th><th>avg_quantity</th><th>avg_refills</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <details>
            <summary>SQL template: Pharmacy pivot (aggregated)</summary>
            <code class="sql" id="sqlPharm"></code>
          </details>
        </div>
      </div>

      <div class="footer">No PHI leaves the warehouse: export aggregated, small CSVs from your database (mart_review views) and load them here. Use Schema Prefix to generate copyable SQL templates.</div>
    </div>
  </div>

  <script>
    const charts = {};
    const datasets = {
      age: [],
      gender: [],
      pmpm: [],
      membersClaims: [],
      claimsEnrollment: [],
      conditions: [],
      inpatient: [],
      drg: [],
      ed: [],
      edFacility: [],
      svcCats: [],
      encTypes: [],
      hcc: [],
      pharmacy: [],
      stateMembers: [],
      dischargeByFacility: [],
      readmitRate: []
    };
    let sampleLoaded = false;
    const globalFilters = { data_source: new Set(), payer: new Set(), plan: new Set() };
    const canonical = s => (s==null? '': String(s)).trim();
    const num = v => { if (v===null||v===undefined||v==='') return NaN; const n = Number(String(v).replace(/,/g,'')); return isNaN(n)? NaN : n; };

    function byId(id) { return document.getElementById(id); }
    function showError(msg) { const el = byId('errorBox'); el.textContent = msg; el.style.display = 'block'; }
    function clearError() { const el = byId('errorBox'); el.style.display = 'none'; el.textContent = ''; }
    function showInfo(msg) { const el = byId('infoBox'); el.textContent = msg; el.style.display = 'block'; setTimeout(()=>{ el.style.display='none'; }, 4000); }

    function pickFiles() { byId('file').click(); }
    function dragOver(e) { e.preventDefault(); byId('drop').classList.add('dragover'); }
    function dragLeave(e) { e.preventDefault(); byId('drop').classList.remove('dragover'); }
    function dropFiles(e) { e.preventDefault(); byId('drop').classList.remove('dragover'); const files = Array.from(e.dataTransfer.files||[]); if (files.length) maybeClearSample(); files.forEach(readFile); }
    byId('file').addEventListener('change', e => { const arr = Array.from(e.target.files||[]); if (arr.length) maybeClearSample(); arr.forEach(readFile); e.target.value=''; });

    function readFile(file) {
      const reader = new FileReader();
      reader.onload = e => { try { routeCSV(e.target.result, file && file.name ? file.name : ''); } catch(err){ console.error(err); showError('Error parsing CSV: '+(err.message||err)); } };
      reader.readAsText(file);
    }

    function clearDatasets() {
      Object.keys(datasets).forEach(k => { if (Array.isArray(datasets[k])) datasets[k] = []; });
      globalFilters.data_source.clear(); globalFilters.payer.clear(); globalFilters.plan.clear();
      ['avgAge','populationCount','ipEncounters','ipReadmitRate','ipAvgLos'].forEach(id=>{ const el=byId(id); if (el) el.textContent='—'; });
      Object.keys(charts).forEach(id=>{ try{ charts[id].destroy(); }catch(_e){} delete charts[id]; });
      populateFilters();
      renderAll();
    }
    function maybeClearSample() { if (sampleLoaded) { clearDatasets(); sampleLoaded=false; showInfo('Sample datasets cleared.'); } }
    function clearAll() { sampleLoaded=false; clearDatasets(); showInfo('Cleared all datasets.'); }

    function parseCSV(text) {
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim().split('\n');
      if (!lines.length) return [];
      const headers = parseCSVLine(lines[0]).map(h => h.replace(/\"/g,'"').replace(/"/g,'').trim().toLowerCase());
      const rows = [];
      for (let i=1;i<lines.length;i++) {
        const line = lines[i]; if (!line.trim()) continue;
        const values = parseCSVLine(line).map(v => v.replace(/\"/g,'"').replace(/"/g,'').trim());
        const obj = {}; headers.forEach((h,idx)=> obj[h]=values[idx]??''); rows.push(obj);
      }
      return rows;
    }
    function parseCSVLine(line) {
      const out = []; let cur=''; let inQ=false; for (let i=0;i<line.length;i++){ const ch=line[i]; if (ch==='"'){ inQ=!inQ; continue; } if (ch===',' && !inQ){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out; }

    function routeCSV(csvText, sourceName='') {
      clearError();
      const rows = parseCSV(csvText);
      if (!rows.length) { showError('Empty CSV.'); return; }
      const cols = new Set(Object.keys(rows[0]).map(c=>c.toLowerCase()));
      // Heuristics to classify
      const has = (...c)=> c.every(x=> cols.has(x));
      const isUnified = has('metric','value') && (cols.has('dim1_name') || cols.has('dim1'));
      if (isUnified) { loadUnifiedCSV(rows); indexFilters(rows); populateFilters(); renderAll(); showInfo('Loaded unified export: '+rows.length.toLocaleString()+' rows.'); return; }
      if (has('age_bucket','count')) { datasets.age.push(...rows); }
      else if (has('gender','count')) { datasets.gender.push(...rows); }
      else if (has('year_month') && (cols.has('total_paid') || cols.has('total_paid_absolute'))) { datasets.pmpm.push(...rows); }
      else if (has('year_month') && (cols.has('members_with_claims') || cols.has('percent_members_with_claims'))) { datasets.membersClaims.push(...rows); }
      else if (has('year_month') && (cols.has('claims_with_enrollment') || cols.has('percentage_claims_with_enrollment'))) { datasets.claimsEnrollment.push(...rows); }
      else if (has('condition','count')) { datasets.conditions.push(...rows); }
      else if (has('los_groups','count')) { datasets.inpatient.push(...rows); }
      else if (has('state') && (cols.has('count') || cols.has('members') || cols.has('member_count'))) { datasets.stateMembers.push(...rows); }
      else if (has('drg_code') && (cols.has('count') || cols.has('encounters'))) { datasets.drg.push(...rows); }
      else if (has('hcc_code') && (cols.has('count') || cols.has('count_members'))) { datasets.hcc.push(...rows); }
      else if (has('avoidable_category','count')) { datasets.ed.push(...rows); }
      else if (has('avoidable_category','spend')) { datasets.ed.push(...rows); }
      else if (has('facility_id','spend') && (cols.has('ed_flag') || cols.has('ed'))) { datasets.edFacility.push(...rows); }
      else if (has('facility_id','discharge_location') && (cols.has('count') || cols.has('encounters'))) { datasets.dischargeByFacility.push(...rows); }
      else if ((cols.has('readmission_rate') || cols.has('rate')) && (cols.has('data_source') || cols.has('payer') || cols.has('plan'))) { datasets.readmitRate.push(...rows); }
      else if (has('service_category_1') && (cols.has('paid_amt') || cols.has('visits'))) { datasets.svcCats.push(...rows); }
      else if ((cols.has('encounter_group') || cols.has('encounter_type')) && (cols.has('count') || cols.has('encounters')) && (cols.has('paid_amount') || cols.has('paid'))) { datasets.encTypes.push(...rows); }
      else if ((cols.has('ndc_code') || cols.has('ndc')) && (cols.has('spend') || cols.has('paid_amount'))) { datasets.pharmacy.push(...rows); }
      else { showError('Unrecognized CSV schema. Ensure you export aggregated datasets with expected columns.'); return; }
      indexFilters(rows);
      populateFilters();
      renderAll();
      showInfo('Loaded '+(sourceName||'dataset')+': '+rows.length.toLocaleString()+' rows.');
    }

    function loadUnifiedCSV(rows) {
      const pmpmMap = new Map();
      const svcMap = new Map();
      const encMap = new Map();
      const pharmMap = new Map();
      const key3 = (a,b,c) => `${a}||${b||''}||${c||''}`;
      const key4 = (a,b,c,d) => `${a}||${b||''}||${c||''}||${d||''}`;
      const key6 = (a,b,c,d,e,f) => `${a}||${b||''}||${c||''}||${d||''}||${e||''}||${f||''}`;
      rows.forEach(r => {
        const ds = canonical(r.data_source||'');
        const payer = canonical(r.payer||'');
        const plan = canonical(r.plan||'');
        const ym = canonical(r.year_month||'');
        const metric = canonical(r.metric||'');
        const d1n = canonical(r.dim1_name||r.dim1||'');
        const d1v = canonical(r.dim1_value||r.dim1val||'');
        const d1l = canonical(r.dim1_label||'');
        const d2n = canonical(r.dim2_name||'');
        const d2v = canonical(r.dim2_value||'');
        const d2l = canonical(r.dim2_label||'');
        const val = num(r.value);
        if (isNaN(val)) return;
        switch(metric){
          case 'age_distribution':
            datasets.age.push({ data_source: ds, payer, plan, age_bucket: d1v, count: val });
            break;
          case 'gender_distribution':
            datasets.gender.push({ data_source: ds, payer, plan, gender: d1v, count: val });
            break;
          case 'pmpm_total':
          case 'pmpm_medical':
          case 'pmpm_pharmacy': {
            const k = key4(ds,payer,plan,ym);
            const obj = pmpmMap.get(k) || { data_source: ds, payer, plan, year_month: ym };
            if (metric==='pmpm_total') obj.total_paid = val;
            else if (metric==='pmpm_medical') obj.medical_paid = val;
            else if (metric==='pmpm_pharmacy') obj.pharmacy_paid = val;
            pmpmMap.set(k,obj);
            break; }
          case 'members_with_claims_pct':
            datasets.membersClaims.push({ data_source: ds, payer, plan, year_month: ym, percent_members_with_claims: val });
            break;
          case 'claims_with_enrollment_pct':
            datasets.claimsEnrollment.push({ data_source: ds, payer, plan, year_month: ym, percentage_claims_with_enrollment: val });
            break;
          case 'condition_count':
            datasets.conditions.push({ data_source: ds, payer, plan, condition: d1v, count: val });
            break;
          case 'inpatient_los':
            datasets.inpatient.push({ data_source: ds, payer, plan, los_groups: d1v, count: val });
            break;
          case 'drg_count':
            datasets.drg.push({ data_source: ds, payer, plan, drg_code: d1v, drg_description: d1l, count: val });
            break;
          case 'ed_avoidable':
            datasets.ed.push({ data_source: ds, payer, plan, avoidable_category: d1v, count: val });
            break;
          case 'ed_avoidable_spend':
            datasets.ed.push({ data_source: ds, payer, plan, avoidable_category: d1v, spend: val });
            break;
          case 'ed_facility_spend':
            datasets.edFacility.push({ data_source: ds, payer, plan, facility_id: d1v, spend: val });
            break;
          case 'discharge_by_facility':
            datasets.dischargeByFacility.push({ data_source: ds, payer, plan, facility_id: d1v, discharge_location: d2v, count: val });
            break;
          case 'state_members':
            datasets.stateMembers.push({ data_source: ds, payer, plan, state: d1v, count: val });
            break;
          case 'readmission_rate':
            datasets.readmitRate.push({ data_source: ds, payer, plan, year_month: ym, readmission_rate: val });
            break;
          case 'svc_paid_amt':
          case 'svc_visits': {
            const k = key6(ds,payer,plan,ym,d1v,d2v);
            const obj = svcMap.get(k) || { data_source: ds, payer, plan, year_month: ym, service_category_1: d1v, service_category_2: d2v, paid_amt: 0, visits: 0 };
            if (metric==='svc_paid_amt') obj.paid_amt = val;
            else obj.visits = val;
            svcMap.set(k,obj);
            break; }
          case 'encounter_count_by_group':
          case 'encounter_paid_by_group': {
            const k = key3(ds,payer,plan)+`||group||${d1v}`;
            const obj = encMap.get(k) || { data_source: ds, payer, plan, encounter_group: d1v, count: 0, paid_amount: 0 };
            if (metric==='encounter_count_by_group') obj.count = val; else obj.paid_amount = val;
            encMap.set(k,obj);
            break; }
          case 'encounter_count_by_type':
          case 'encounter_paid_by_type': {
            const k = key3(ds,payer,plan)+`||type||${d1v}`;
            const obj = encMap.get(k) || { data_source: ds, payer, plan, encounter_type: d1v, count: 0, paid_amount: 0 };
            if (metric==='encounter_count_by_type') obj.count = val; else obj.paid_amount = val;
            encMap.set(k,obj);
            break; }
          case 'hcc_count':
            datasets.hcc.push({ data_source: ds, payer, plan, hcc_code: d1v, hcc_description: d1l, count: val });
            break;
          case 'pharm_spend':
          case 'pharm_avg_days_supply':
          case 'pharm_avg_quantity':
          case 'pharm_avg_refills': {
            const k = key6(ds,payer,plan,'',d1v,d2v);
            const obj = pharmMap.get(k) || { data_source: ds, payer, plan, theraclass: d1v, ndc_code: d2v, ndc_description: d2l, spend: 0, avg_days_supply: NaN, avg_quantity: NaN, avg_refills: NaN };
            if (metric==='pharm_spend') obj.spend = val;
            else if (metric==='pharm_avg_days_supply') obj.avg_days_supply = val;
            else if (metric==='pharm_avg_quantity') obj.avg_quantity = val;
            else if (metric==='pharm_avg_refills') obj.avg_refills = val;
            pharmMap.set(k,obj);
            break; }
          default:
            break;
        }
      });
      // materialize maps
      pmpmMap.forEach(v => datasets.pmpm.push(v));
      svcMap.forEach(v => datasets.svcCats.push(v));
      encMap.forEach(v => datasets.encTypes.push(v));
      pharmMap.forEach(v => datasets.pharmacy.push(v));
    }

    function indexFilters(rows) {
      rows.forEach(r => {
        const ds = canonical(r.data_source||''); if (ds) globalFilters.data_source.add(ds);
        const payer = canonical(r.payer||''); if (payer) globalFilters.payer.add(payer);
        const plan = canonical(r.plan||''); if (plan) globalFilters.plan.add(plan);
      });
    }
    function populateFilters() {
      const dd = (id,set) => { const el=byId(id); const cur=el.value; el.innerHTML=''; const optAll=document.createElement('option'); optAll.value=''; optAll.textContent='(all)'; el.appendChild(optAll); Array.from(set).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); }); if ([...set].includes(cur)) el.value=cur; };
      dd('selDataSource', globalFilters.data_source);
      dd('selPayer', globalFilters.payer);
      dd('selPlan', globalFilters.plan);
    }
    function handleFilterChange(){ renderAll(); }

    function filterRows(arr) {
      const ds = byId('selDataSource').value; const payer = byId('selPayer').value; const plan = byId('selPlan').value;
      // Treat missing dimensions in a row as wildcard to avoid dropping aggregated rows
      return (arr||[]).filter(r => {
        const rds = canonical(r.data_source||'');
        const rpy = canonical(r.payer||'');
        const rpl = canonical(r.plan||'');
        const dsOk = (!ds) || rds === ds || rds === '';
        const pyOk = (!payer) || rpy === payer || rpy === '';
        const plOk = (!plan) || rpl === plan || rpl === '';
        return dsOk && pyOk && plOk;
      });
    }

    function toMonthDate(ym) { const s = String(ym||''); if (s.length===6) { const y=+s.slice(0,4), m=+s.slice(4,6); return new Date(y, m-1, 1); } return null; }
    function formatMoney(n) { if (n==null || isNaN(n)) return '—'; return '$'+Number(n).toLocaleString(undefined,{maximumFractionDigits:0}); }
    function formatNum(n) { if (n==null || isNaN(n)) return '—'; return Number(n).toLocaleString(); }
    function pct(n) { if (n==null || isNaN(n)) return '—'; return (Number(n)*100).toFixed(1)+'%'; }

    function ensureChart(id, type, config){
      const el = byId(id);
      if (!el) return;
      if (charts[id]) { try { charts[id].destroy(); } catch(_e){} }
      // Clear any inline sizes applied by Chart.js from previous renders to prevent growth
      el.removeAttribute('width'); el.removeAttribute('height');
      if (el.style) { el.style.width=''; el.style.height=''; }
      charts[id] = new Chart(el, { type, data: config.data, options: config.options||{} });
    }

    function renderAll() {
      renderAge(); renderGender(); renderPmpm(); renderMembersClaims(); renderClaimsEnrollment(); renderConditions(); renderInpatient(); renderDrg(); renderEd(); renderSvcCats(); renderEncTypes(); renderHcc(); renderPharmacy(); renderStateTable(); renderInpatientKPIs(); renderEdFacility(); renderDischargeFacility(); renderReadmitChart();
      injectSQLTemplates();
    }

    function renderAge() {
      const rows = filterRows(datasets.age).map(r=>({
        age_bucket: canonical(r.age_bucket),
        count: num(r.count),
        avg_age: num(r.avg_age)
      })).filter(r=> r.age_bucket);
      // Helper: fallback midpoint for bucket when avg_age missing
      const bucketMid = (b)=>{
        const m = String(b||'');
        const m1 = m.match(/^(\d+)[^\d]+(\d+)/); if (m1) { const a=+m1[1], c=+m1[2]; return (a+c)/2; }
        if (/^00-04$/.test(m)) return 2;
        if (/^05-17$/.test(m)) return 11;
        if (/^18-29$/.test(m)) return 23.5;
        if (/^30-39$/.test(m)) return 35;
        if (/^40-49$/.test(m)) return 45;
        if (/^50-59$/.test(m)) return 55;
        if (/^60-69$/.test(m)) return 65;
        if (/^70-79$/.test(m)) return 75;
        if (/80\+/.test(m)) return 85;
        return NaN;
      };
      // Compute weighted average using per-row avg_age if available; else bucket midpoint
      let sumVal = 0, sumCnt = 0;
      rows.forEach(r=>{
        const v = !isNaN(r.avg_age) ? r.avg_age : bucketMid(r.age_bucket);
        if (!isNaN(v) && !isNaN(r.count)) { sumVal += v * r.count; sumCnt += r.count; }
      });
      const wAvg = sumCnt ? (sumVal / sumCnt) : NaN;
      // Aggregate counts across payer/plan to single series per bucket
      const byBucket = new Map();
      rows.forEach(r=>{ const k=r.age_bucket; const v=byBucket.get(k)||0; byBucket.set(k, v + (isNaN(r.count)?0:r.count)); });
      const order = ['00-04','05-17','18-29','30-39','40-49','50-59','60-69','70-79','80+'];
      const labels = Array.from(byBucket.keys()).sort((a,b)=>{
        const ia = order.indexOf(a); const ib = order.indexOf(b);
        if (ia>=0 && ib>=0) return ia-ib; if (ia>=0) return -1; if (ib>=0) return 1; return a.localeCompare(b);
      });
      const series = labels.map(k=> byBucket.get(k)||0);
      const total = series.reduce((s,v)=> s+v, 0);
      byId('populationCount').textContent = formatNum(total);
      byId('avgAge').textContent = isNaN(wAvg)? '—' : (wAvg).toFixed(1);
      const data = { labels, datasets:[{ label:'Members', data: series, backgroundColor:'#3b82f6' }] };
      ensureChart('chartAgeHist','bar',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } });
    }

    function renderGender() {
      // Aggregate counts across payer/plan by gender
      const arr = filterRows(datasets.gender).map(r=>({ gender: canonical(r.gender)||'(unknown)', count: num(r.count) })).filter(r=> !isNaN(r.count));
      const byGender = new Map();
      arr.forEach(r=>{ const v=byGender.get(r.gender)||0; byGender.set(r.gender, v + r.count); });
      const rows = Array.from(byGender.entries()).map(([gender,count])=>({gender,count}));
      const labels = rows.map(r=>r.gender);
      const data = { labels, datasets:[{ label:'Members', data: rows.map(r=>r.count||0), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16'] }] };
      ensureChart('chartGender','doughnut',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} } } });
    }

    function renderPmpm() {
      const rows = filterRows(datasets.pmpm).map(r=>({
        ym: toMonthDate(r.year_month||r.yearmonth||r.ym),
        total: num(r.total_paid)||num(r.total_pmpm)||num(r.total),
        medical: num(r.medical_paid)||NaN,
        pharmacy: num(r.pharmacy_paid)||NaN
      })).filter(r=>r.ym);
      rows.sort((a,b)=> a.ym - b.ym);
      const labels = rows.map(r=> r.ym.toLocaleDateString('en-US',{month:'short',year:'numeric'}));
      const data = { labels, datasets:[
        { label:'Total PMPM', data: rows.map(r=>r.total||0), borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.3)', fill:false },
        { label:'Medical PMPM', data: rows.map(r=>r.medical||0), borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.3)', fill:false },
        { label:'Pharmacy PMPM', data: rows.map(r=>r.pharmacy||0), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.3)', fill:false }
      ] };
      ensureChart('chartPmpm','line',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ tooltip:{ callbacks:{ label:(ctx)=> ctx.dataset.label+': '+formatMoney(ctx.parsed.y) } } } } });
    }

    function renderMembersClaims() {
      // Aggregate across payer/plan: sum members_with_claims and member_months per month
      const arr = filterRows(datasets.membersClaims);
      const map = new Map();
      arr.forEach(r=>{
        const ymStr = String(r.year_month||'');
        if (!ymStr) return;
        const mm = num(r.total_member_months);
        const mwc = num(r.members_with_claims);
        const pct = num(r.percent_members_with_claims);
        const v = map.get(ymStr) || { ym: toMonthDate(ymStr), num:0, den:0, pctSum:0, pctN:0 };
        if (!isNaN(mwc)) v.num += mwc;
        if (!isNaN(mm)) v.den += mm;
        if (isNaN(mwc) || isNaN(mm)) { if (!isNaN(pct)) { v.pctSum += pct; v.pctN += 1; } }
        map.set(ymStr, v);
      });
      const rows = Array.from(map.values()).filter(r=> r.ym).sort((a,b)=> a.ym - b.ym).map(r=>({ ym:r.ym, pct: (r.den>0? (r.num/r.den) : (r.pctN>0? (r.pctSum/r.pctN) : NaN)) }));
      const labels = rows.map(r=> r.ym.toLocaleDateString('en-US',{month:'short',year:'numeric'}));
      const data = { labels, datasets:[{ label:'Members with claims %', data: rows.map(r=>r.pct||0), borderColor:'#9333ea', backgroundColor:'rgba(147,51,234,0.25)', fill:false }] };
      ensureChart('chartMembersClaims','line',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ tooltip:{ callbacks:{ label:(ctx)=> ctx.dataset.label+': '+pct(ctx.parsed.y) } }, legend:{display:false} }, scales:{ y:{ ticks:{ callback:(v)=> (v*100)+'%' } } } } });
    }

    function renderClaimsEnrollment() {
      // Aggregate across payer/plan: sum claims_with_enrollment and claims per month
      const arr = filterRows(datasets.claimsEnrollment);
      const map = new Map();
      arr.forEach(r=>{
        const ymStr = String(r.year_month||''); if (!ymStr) return;
        const ce = num(r.claims_with_enrollment);
        const cl = num(r.claims);
        const pct = num(r.percentage_claims_with_enrollment);
        const v = map.get(ymStr) || { ym: toMonthDate(ymStr), num:0, den:0, pctSum:0, pctN:0 };
        if (!isNaN(ce)) v.num += ce;
        if (!isNaN(cl)) v.den += cl;
        if (isNaN(ce) || isNaN(cl)) { if (!isNaN(pct)) { v.pctSum += pct; v.pctN += 1; } }
        map.set(ymStr, v);
      });
      const rows = Array.from(map.values()).filter(r=> r.ym).sort((a,b)=> a.ym - b.ym).map(r=>({ ym:r.ym, pct: (r.den>0? (r.num/r.den) : (r.pctN>0? (r.pctSum/r.pctN) : NaN)) }));
      const labels = rows.map(r=> r.ym.toLocaleDateString('en-US',{month:'short',year:'numeric'}));
      const data = { labels, datasets:[{ label:'Claims with enrollment %', data: rows.map(r=>r.pct||0), borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.25)', fill:false }] };
      ensureChart('chartClaimsEnrollment','line',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ tooltip:{ callbacks:{ label:(ctx)=> ctx.dataset.label+': '+pct(ctx.parsed.y) } }, legend:{display:false} }, scales:{ y:{ ticks:{ callback:(v)=> (v*100)+'%' } } } } });
    }

    function renderConditions() {
      // Aggregate counts across payer/plan for each condition, while respecting selected payer/plan
      const wantPayer = byId('selPayer').value; const wantPlan = byId('selPlan').value;
      const arrRaw = filterRows(datasets.conditions).map(r=>({ condition: canonical(r.condition), payer: canonical(r.payer||''), plan: canonical(r.plan||''), count: num(r.count) })).filter(r=> r.condition && !isNaN(r.count));
      const arr = arrRaw.filter(r=> { if (wantPayer && r.payer !== wantPayer) return false; if (wantPlan && r.plan !== wantPlan) return false; return true; });
      const byCond = new Map();
      arr.forEach(r=>{ const v=byCond.get(r.condition)||0; byCond.set(r.condition, v + r.count); });
      const rows = Array.from(byCond.entries()).map(([condition,count])=>({condition,count}));
      rows.sort((a,b)=> b.count - a.count);
      const top = rows.slice(0, 15);
      const data = { labels: top.map(r=>r.condition), datasets:[{ label:'Members', data: top.map(r=>r.count), backgroundColor:'#0ea5e9' }] };
      ensureChart('chartConditions','bar',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, indexAxis:'y' } });
    }

    function renderInpatient() {
      // Aggregate LOS buckets across payer/plan
      const arr = filterRows(datasets.inpatient).map(r=>({ group: canonical(r.los_groups), count: num(r.count) })).filter(r=> r.group && !isNaN(r.count));
      const byGroup = new Map();
      arr.forEach(r=>{ const v=byGroup.get(r.group)||0; byGroup.set(r.group, v + r.count); });
      const rows = Array.from(byGroup.entries()).map(([group,count])=>({group,count})).sort((a,b)=> a.group.localeCompare(b.group));
      const data = { labels: rows.map(r=>r.group), datasets:[{ label:'Encounters', data: rows.map(r=>r.count), backgroundColor:'#14b8a6' }] };
      ensureChart('chartInpatientLos','bar',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} } } });
    }

    function renderDrg() {
      const rows = filterRows(datasets.drg).map(r=>{
        const code = canonical(r.drg_code)||canonical(r.drg);
        const desc = canonical(r.drg_description)||canonical(r.drgwithdescription)||'';
        const label = (desc && code) ? `${desc} (${code})` : (code || desc);
        return { drg: label, count: num(r.count)||num(r.encounters) };
      }).filter(r=>!isNaN(r.count));
      rows.sort((a,b)=> b.count - a.count); const top = rows.slice(0, 12);
      const data = { labels: top.map(r=>r.drg), datasets:[{ label:'Encounters', data: top.map(r=>r.count), backgroundColor:'#6366f1' }] };
      ensureChart('chartDrg','bar',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, indexAxis:'y', layout:{ padding:{ left: 24, right: 8 } } } });
    }

    function renderEd() {
      const rows = filterRows(datasets.ed).map(r=>({ cat: canonical(r.avoidable_category)||canonical(r.ed_classification)||canonical(r.category), count: num(r.count), spend: num(r.spend)}));
      const byCat = new Map();
      rows.forEach(r=>{ const k=r.cat||'(unknown)'; const v=byCat.get(k)||{count:0, spend:0}; v.count += (isNaN(r.count)?0:r.count); v.spend += (isNaN(r.spend)?0:r.spend); byCat.set(k,v); });
      const arr = Array.from(byCat.entries()).map(([cat,v])=>({cat, ...v}));
      const dataCount = { labels: arr.map(r=>r.cat), datasets:[{ label:'Encounters', data: arr.map(r=>r.count), backgroundColor:['#22c55e','#f97316','#3b82f6','#eab308','#ef4444'] }] };
      ensureChart('chartEd','bar',{ data: dataCount, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} } } });
      const dataSpend = { labels: arr.map(r=>r.cat), datasets:[{ label:'Spend', data: arr.map(r=>r.spend), backgroundColor:'rgba(59,130,246,0.5)' }] };
      ensureChart('chartEdSpend','bar',{ data: dataSpend, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=> 'Spend: '+formatMoney(c.parsed.y) } } } } });
    }

    function renderSvcCats() {
      const rows = filterRows(datasets.svcCats).map(r=>({
        cat1: canonical(r.service_category_1),
        cat2: canonical(r.service_category_2),
        cat3: canonical(r.service_category_3),
        paid: num(r.paid_amt)||num(r.paid_amount),
        visits: num(r.visits)
      }));
      const hasSc3 = rows.some(r=> r.cat3);
      const m1 = new Map();
      rows.forEach(r=>{
        const c1 = r.cat1||'(unknown)'; const c2 = r.cat2||''; const c3 = hasSc3 ? (r.cat3||'') : '';
        const level1 = m1.get(c1) || { paid:0, visits:0, children:new Map() };
        level1.paid += (r.paid||0); level1.visits += (r.visits||0);
        const m2 = level1.children; const level2 = m2.get(c2) || { paid:0, visits:0, children: new Map() };
        level2.paid += (r.paid||0); level2.visits += (r.visits||0);
        if (hasSc3 && c3) { const m3 = level2.children; const level3 = m3.get(c3) || { paid:0, visits:0 }; level3.paid += (r.paid||0); level3.visits += (r.visits||0); m3.set(c3, level3); }
        m2.set(c2, level2); m1.set(c1, level1);
      });
      const tbody = byId('tblSvc').querySelector('tbody'); if (!tbody) return; tbody.innerHTML='';
      const encode = s => (s||'').replace(/[^a-zA-Z0-9_\-]+/g,'_');
      const parents = Array.from(m1.entries()).map(([k,v])=>({ k, ...v })).sort((a,b)=> b.paid - a.paid);
      parents.forEach(p=>{
        const id1 = 'sc1_'+encode(p.k);
        const tr1=document.createElement('tr'); tr1.className='parent'; tr1.dataset.key=id1;
        const td1=document.createElement('td'); td1.innerHTML = `<span class="toggle" data-target="${id1}">▶</span> ${p.k}`;
        const td2=document.createElement('td'); td2.textContent=''; const td3=document.createElement('td'); td3.textContent='';
        const td4=document.createElement('td'); td4.textContent = formatMoney(p.paid);
        const td5=document.createElement('td'); td5.textContent = formatNum(p.visits);
        [td1,td2,td3,td4,td5].forEach(td=> tr1.appendChild(td)); tbody.appendChild(tr1);
        const lvl2 = Array.from(p.children.entries()).map(([k,v])=>({k,...v})).sort((a,b)=> b.paid - a.paid);
        lvl2.forEach(c=>{
          const id2 = id1+'__'+encode(c.k||'other');
          const tr2=document.createElement('tr'); tr2.className='child child-of-'+id1; tr2.style.display='none';
          const td21=document.createElement('td'); td21.textContent='';
          const td22=document.createElement('td'); td22.innerHTML = `<span class="toggle" data-target="${id2}">${hasSc3? '▶':''}</span> ${c.k||'(none)'}`;
          const td23=document.createElement('td'); td23.textContent='';
          const td24=document.createElement('td'); td24.textContent = formatMoney(c.paid);
          const td25=document.createElement('td'); td25.textContent = formatNum(c.visits);
          [td21,td22,td23,td24,td25].forEach(td=> tr2.appendChild(td)); tbody.appendChild(tr2);
          if (hasSc3) {
            const lvl3 = Array.from(c.children.entries()).map(([k,v])=>({k,...v})).sort((a,b)=> b.paid - a.paid);
            lvl3.forEach(g=>{
              const tr3=document.createElement('tr'); tr3.className='grand child-of-'+id2; tr3.style.display='none';
              const td31=document.createElement('td'); td31.textContent='';
              const td32=document.createElement('td'); td32.textContent='';
              const td33=document.createElement('td'); td33.textContent=g.k||'(none)';
              const td34=document.createElement('td'); td34.textContent = formatMoney(g.paid);
              const td35=document.createElement('td'); td35.textContent = formatNum(g.visits);
              [td31,td32,td33,td34,td35].forEach(td=> tr3.appendChild(td)); tbody.appendChild(tr3);
            });
          }
        });
      });
      // wire toggles
      tbody.querySelectorAll('span.toggle').forEach(el=>{
        el.style.cursor='pointer';
        el.addEventListener('click', (e)=>{
          const tgt = e.currentTarget.getAttribute('data-target');
          const children = tbody.querySelectorAll('.child-of-'+tgt);
          const showing = Array.from(children).some(r=> r.style.display!== 'none');
          children.forEach(r=> r.style.display = showing? 'none' : 'table-row');
          e.currentTarget.textContent = showing? '▶' : '▼';
        });
      });
    }

    function renderHcc() {
      const wantPayer = byId('selPayer').value; const wantPlan = byId('selPlan').value;
      const arr = filterRows(datasets.hcc).map(r=>({
        code: canonical(r.hcc_code)||canonical(r.hcc),
        desc: canonical(r.hcc_description)||canonical(r.hcc_label)||'',
        payer: canonical(r.payer||''),
        plan: canonical(r.plan||''),
        count: num(r.count)
      })).filter(r=> !isNaN(r.count));
      // Enforce payer/plan filter when set: drop rows missing those dims
      const filtered = arr.filter(r=> {
        if (wantPayer && r.payer !== wantPayer) return false;
        if (wantPlan && r.plan !== wantPlan) return false;
        return true;
      });
      const byCode = new Map();
      filtered.forEach(r=>{ const v=byCode.get(r.code)||{count:0, desc:r.desc}; v.count += r.count; if (!v.desc && r.desc) v.desc = r.desc; byCode.set(r.code, v); });
      const rows = Array.from(byCode.entries()).map(([code,v])=>({ label: (v.desc? `${v.desc} (${code})` : code), count: v.count }));
      rows.sort((a,b)=> b.count - a.count); const top = rows.slice(0,15);
      const data = { labels: top.map(r=>r.label), datasets:[{ label:'Members', data: top.map(r=>r.count), backgroundColor:'#fb7185' }] };
      ensureChart('chartHcc','bar',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, indexAxis:'y' } });
    }

    function renderEncTypes() {
      const deriveGroup = (t)=>{
        const s = (t||'').toLowerCase();
        if (!s) return '';
        if (s.includes('inpatient')) return 'inpatient';
        if (s.includes('emergency')) return 'emergency';
        if (s.includes('office')) return 'office based';
        if (s.includes('tele') || s.includes('virtual')) return 'office based';
        if (s.includes('outpatient')) return 'outpatient';
        if (s.includes('surgery')) return 'outpatient';
        if (s.includes('skilled') || s.includes('snf') || s.includes('home health') || s.includes('rehab') || s.includes('ltch') || s.includes('long term')) return 'post-acute';
        return '';
      };
      const rows = filterRows(datasets.encTypes).map(r=>({
        group: canonical(r.encounter_group)||'', type: canonical(r.encounter_type)||'',
        count: num(r.count)||num(r.encounters), paid: num(r.paid_amount)||num(r.paid)
      })).filter(r=>!isNaN(r.count));
      const map = new Map();
      rows.forEach(r=>{
        const gRaw = r.group || deriveGroup(r.type);
        const g = gRaw || '(unknown)';
        const v = map.get(g)||{paid:0,count:0,children:new Map()};
        v.count+=(r.count||0); v.paid+=(r.paid||0);
        const m=v.children; const t = r.type || '(unknown)';
        const c=m.get(t)||{paid:0,count:0}; c.count+=(r.count||0); c.paid+=(r.paid||0); m.set(t,c);
        map.set(g,v);
      });
      const tbody = byId('tblEnc').querySelector('tbody'); if (!tbody) return; tbody.innerHTML='';
      const encode = s => (s||'').replace(/[^a-zA-Z0-9_\-]+/g,'_');
      const groups = Array.from(map.entries()).map(([k,v])=>({k,...v})).sort((a,b)=> b.count-a.count);
      groups.forEach(g=>{
        const id = 'enc_'+encode(g.k);
        const tr=document.createElement('tr'); tr.className='parent'; tr.dataset.key=id;
        const td1=document.createElement('td'); td1.innerHTML = `<span class="toggle" data-target="${id}">▶</span> ${g.k}`;
        const td2=document.createElement('td'); td2.textContent='';
        const td3=document.createElement('td'); td3.textContent=formatNum(g.count);
        const td4=document.createElement('td'); td4.textContent=formatMoney(g.paid);
        [td1,td2,td3,td4].forEach(td=> tr.appendChild(td)); tbody.appendChild(tr);
        const children = Array.from(g.children.entries()).map(([k,v])=>({k,...v})).sort((a,b)=> b.count-a.count);
        children.forEach(c=>{
          const trc=document.createElement('tr'); trc.className='child child-of-'+id; trc.style.display='none';
          const td21=document.createElement('td'); td21.textContent='';
          const td22=document.createElement('td'); td22.textContent=c.k;
          const td23=document.createElement('td'); td23.textContent=formatNum(c.count);
          const td24=document.createElement('td'); td24.textContent=formatMoney(c.paid);
          [td21,td22,td23,td24].forEach(td=> trc.appendChild(td)); tbody.appendChild(trc);
        });
      });
      tbody.querySelectorAll('span.toggle').forEach(el=>{
        el.style.cursor='pointer';
        el.addEventListener('click', (e)=>{
          const tgt = e.currentTarget.getAttribute('data-target');
          const children = tbody.querySelectorAll('.child-of-'+tgt);
          const showing = Array.from(children).some(r=> r.style.display!== 'none');
          children.forEach(r=> r.style.display = showing? 'none' : 'table-row');
          e.currentTarget.textContent = showing? '▶' : '▼';
        });
      });
    }

    function renderPharmacy() {
      const rowsRaw = filterRows(datasets.pharmacy).map(r=>({
        theraclass: canonical(r.theraclass)||canonical(r.atc_3_name)||canonical(r.atc_2_name),
        ndc_code: canonical(r.ndc_code)||canonical(r.ndc),
        ndc_description: canonical(r.ndc_description)||canonical(r.rxnorm_description)||canonical(r.fda_description),
        spend: num(r.spend)||num(r.paid_amount),
        days_supply: num(r.avg_days_supply)||num(r.days_supply),
        quantity: num(r.avg_quantity)||num(r.quantity),
        refills: num(r.avg_refills)||num(r.refills)
      }));
      const includeNdc = byId('chkPharmNdc') && byId('chkPharmNdc').checked;
      const rows = includeNdc ? rowsRaw : aggregatePharmByTheraclass(rowsRaw);
      const tbody = byId('tblPharm').querySelector('tbody');
      tbody.innerHTML='';
      document.querySelectorAll('#tblPharm .ndc-col').forEach(th=> th.style.display = includeNdc? '' : 'none');
      rows.slice(0,500).forEach(r=>{
        const tr=document.createElement('tr');
        const cols = includeNdc ? ['theraclass','ndc_code','ndc_description'] : ['theraclass'];
        cols.forEach(k=>{ const td=document.createElement('td'); td.textContent=r[k]||''; tr.appendChild(td); });
        const tdSpend=document.createElement('td'); tdSpend.textContent = formatMoney(r.spend); tr.appendChild(tdSpend);
        const tdDS=document.createElement('td'); tdDS.textContent = isNaN(r.days_supply)? '—' : r.days_supply.toFixed(1); tr.appendChild(tdDS);
        const tdQty=document.createElement('td'); tdQty.textContent = isNaN(r.quantity)? '—' : r.quantity.toFixed(1); tr.appendChild(tdQty);
        const tdRef=document.createElement('td'); tdRef.textContent = isNaN(r.refills)? '—' : r.refills.toFixed(2); tr.appendChild(tdRef);
        tbody.appendChild(tr);
      });
    }

    function aggregatePharmByTheraclass(rows) {
      const map = new Map();
      rows.forEach(r=>{
        const k=r.theraclass||'(unknown)';
        const v=map.get(k)||{theraclass:k, spend:0, days_supply:0, quantity:0, refills:0, n:0};
        v.spend += (r.spend||0);
        if (!isNaN(r.days_supply)) v.days_supply += r.days_supply;
        if (!isNaN(r.quantity)) v.quantity += r.quantity;
        if (!isNaN(r.refills)) v.refills += r.refills;
        v.n += 1;
        map.set(k,v);
      });
      return Array.from(map.values()).map(v=>({
        theraclass: v.theraclass,
        spend: v.spend,
        days_supply: v.n? v.days_supply/v.n : NaN,
        quantity: v.n? v.quantity/v.n : NaN,
        refills: v.n? v.refills/v.n : NaN
      })).sort((a,b)=> b.spend - a.spend);
    }

    function renderStateTable() {
      const arr = filterRows(datasets.stateMembers).map(r=>({ state: canonical(r.state)||canonical(r.state_name)||canonical(r.normalized_state_name)||'(unknown)', members: num(r.members)||num(r.member_count)||num(r.count) })).filter(r=>!isNaN(r.members));
      const byState = new Map();
      arr.forEach(r=>{ const v=byState.get(r.state)||0; byState.set(r.state, v + r.members); });
      const rows = Array.from(byState.entries()).map(([state,members])=>({state,members}));
      rows.sort((a,b)=> b.members - a.members);
      const tbody = byId('tblState').querySelector('tbody'); if (!tbody) return; tbody.innerHTML='';
      rows.forEach(r=>{ const tr=document.createElement('tr'); const td1=document.createElement('td'); td1.textContent=r.state||'(unknown)'; const td2=document.createElement('td'); td2.textContent=formatNum(r.members); tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr); });
    }

    function renderInpatientKPIs() {
      // Encounters total
      const inptRows = filterRows(datasets.inpatient).map(r=> ({ group: canonical(r.los_groups), count: num(r.count) })).filter(r=> !isNaN(r.count));
      const totalEnc = inptRows.reduce((s,r)=> s + r.count, 0);
      if (byId('ipEncounters')) byId('ipEncounters').textContent = totalEnc? formatNum(totalEnc): '—';
      // Avg LOS from LOS buckets (use midpoints)
      const losMid = (g)=>{
        const m = String(g||'');
        const m1 = m.match(/(\d+)\s*[-–]\s*(\d+)/); if (m1) { const a=+m1[1], b=+m1[2]; return (a+b)/2; }
        if (/0-1/.test(m)) return 0.5;
        if (/2-3/.test(m)) return 2.5;
        if (/4-5/.test(m)) return 4.5;
        if (/6-7/.test(m)) return 6.5;
        if (/8-14/.test(m)) return 11;
        if (/15-30/.test(m)) return 22.5;
        if (/31\+|31\s*\+|31\s*Days|31\s*days|31\s*\+\s*Days/i.test(m)) return 35; // rough tail estimate
        return NaN;
      };
      let sumLos = 0, sumCnt = 0;
      inptRows.forEach(r=>{ const mid = losMid(r.group); if (!isNaN(mid)) { sumLos += mid * r.count; sumCnt += r.count; } });
      const avgLos = sumCnt ? (sumLos / sumCnt) : NaN;
      if (byId('ipAvgLos')) byId('ipAvgLos').textContent = isNaN(avgLos)? '—' : avgLos.toFixed(1);
      // Readmit rate KPI
      const readmit = filterRows(datasets.readmitRate).map(r=> num(r.readmission_rate)||num(r.rate)).filter(v=>!isNaN(v));
      if (byId('ipReadmitRate')) { if (readmit.length) { const avg = readmit.reduce((s,v)=>s+v,0)/readmit.length; byId('ipReadmitRate').textContent = pct(avg); } else { byId('ipReadmitRate').textContent='—'; } }
    }

    function renderReadmitChart() {
      const arr = filterRows(datasets.readmitRate);
      const map = new Map();
      arr.forEach(r=>{
        const ymStr = canonical(r.year_month||'');
        const rate = num(r.readmission_rate)||num(r.rate);
        const key = ymStr || '';
        const v = map.get(key) || { ym: ymStr ? toMonthDate(ymStr) : null, sum:0, n:0 };
        if (!isNaN(rate)) { v.sum += rate; v.n += 1; }
        map.set(key, v);
      });
      const rows = Array.from(map.values()).filter(r=> r.ym).sort((a,b)=> a.ym - b.ym).map(r=> ({ ym: r.ym, rate: r.n? r.sum/r.n : NaN }));
      if (rows.length) {
        const labels = rows.map(r=> r.ym.toLocaleDateString('en-US',{month:'short',year:'numeric'}));
        const data = { labels, datasets:[{ label:'Readmission Rate', data: rows.map(r=>r.rate||0), borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.25)', fill:false }] };
        ensureChart('chartReadmit','line',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=> pct(c.parsed.y) } } }, scales:{ y:{ ticks:{ callback:(v)=> (v*100)+'%' } } } } });
      } else {
        // fallback to overall bar if no monthly grain present
        const vals = arr.map(r=> num(r.readmission_rate)||num(r.rate)).filter(v=>!isNaN(v));
        const avg = vals.length ? (vals.reduce((s,v)=>s+v,0)/vals.length) : NaN;
        const data = { labels: ['Overall'], datasets:[{ label:'Readmission Rate', data: [isNaN(avg)?0:avg], backgroundColor:'#0ea5e9' }] };
        ensureChart('chartReadmit','bar',{ data, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=> pct(c.parsed.y) } } }, scales:{ y:{ ticks:{ callback:(v)=> (v*100)+'%' }, beginAtZero:true, max: Math.min(1, (isNaN(avg)?0.5:Math.max(avg*1.5,0.2))) } } } });
      }
    }

    function renderEdFacility() {
      const rows = filterRows(datasets.edFacility).map(r=>({ facility_id: canonical(r.facility_id)||canonical(r.facility_npi)||canonical(r.facility), spend: num(r.spend)||num(r.paid)||num(r.paid_amount) })).filter(r=>!isNaN(r.spend));
      rows.sort((a,b)=> b.spend - a.spend);
      const tbody = byId('tblEdFacility') ? byId('tblEdFacility').querySelector('tbody') : null; if (!tbody) return; tbody.innerHTML='';
      rows.forEach(r=>{ const tr=document.createElement('tr'); const td1=document.createElement('td'); td1.textContent=r.facility_id||'(unknown)'; const td2=document.createElement('td'); td2.textContent = formatMoney(r.spend); tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr); });
    }

    function renderDischargeFacility() {
      const rows = filterRows(datasets.dischargeByFacility).map(r=>({ facility_id: canonical(r.facility_id)||canonical(r.facility_npi)||canonical(r.facility), discharge_location: canonical(r.discharge_location)||canonical(r.discharge_disposition)||canonical(r.disposition), count: num(r.count)||num(r.encounters) })).filter(r=>!isNaN(r.count));
      rows.sort((a,b)=> b.count - a.count);
      const tbody = byId('tblDischarge') ? byId('tblDischarge').querySelector('tbody') : null; if (!tbody) return; tbody.innerHTML='';
      rows.slice(0,500).forEach(r=>{ const tr=document.createElement('tr'); ['facility_id','discharge_location'].forEach(k=>{ const td=document.createElement('td'); td.textContent=r[k]||''; tr.appendChild(td); }); const td3=document.createElement('td'); td3.textContent=formatNum(r.count); tr.appendChild(td3); tbody.appendChild(tr); });
    }

    function injectSQLTemplates() {
      const pfx = (byId('schemaPrefix').value||'data_quality').trim();
      byId('sqlAge').textContent = `-- Age distribution joined to member_months for payer/plan (no PHI)\nwith base as (\n  select p.data_source, mm.payer, mm.plan,\n         case when p.age < 5 then '00-04' when p.age < 18 then '05-17' when p.age < 30 then '18-29'\n              when p.age < 40 then '30-39' when p.age < 50 then '40-49' when p.age < 60 then '50-59'\n              when p.age < 70 then '60-69' when p.age < 80 then '70-79' else '80+' end as age_bucket,\n         p.age\n  from ${pfx}.mart_review__patient p\n  left join ${pfx}.mart_review__member_months mm\n    on p.person_id = mm.person_id and p.data_source = mm.data_source\n), agg as (\n  select data_source, payer, plan, age_bucket, count(*) as count, avg(age) as avg_age\n  from base group by 1,2,3,4\n) select * from agg order by data_source, payer, plan, age_bucket;`;
      byId('sqlGender').textContent = `-- Gender distribution joined to member_months for payer/plan (no PHI)\nselect p.data_source, mm.payer, mm.plan, p.sex as gender, count(*) as count\nfrom ${pfx}.mart_review__patient p\nleft join ${pfx}.mart_review__member_months mm\n  on p.person_id = mm.person_id and p.data_source = mm.data_source\nwhere p.sex is not null\ngroup by 1,2,3,4;`;
      byId('sqlState').textContent = `-- Members by state (no PHI)\nselect p.data_source, mm.payer, mm.plan, p.state as state, count(distinct p.person_id) as count\nfrom ${pfx}.mart_review__patient p\nleft join ${pfx}.mart_review__member_months mm\n  on p.person_id = mm.person_id and p.data_source = mm.data_source\nwhere p.state is not null\ngroup by 1,2,3,4\norder by 5 desc;`;
      byId('sqlPmpm').textContent = `-- PMPM by month (no PHI)\nselect data_source, payer, plan, year_month, total_paid as total_paid, medical_paid, pharmacy_paid\nfrom ${pfx}.mart_review__pmpm;`;
      byId('sqlMembersClaims').textContent = `-- Members with claims by month (no PHI)\nselect data_source, year_month, total_member_months, members_with_claims,\n  cast(members_with_claims/ nullif(total_member_months,0) as numeric) as percent_members_with_claims\nfrom ${pfx}.mart_review__members_with_claims;`;
      byId('sqlClaimsEnrollment').textContent = `-- Claims with enrollment by month (no PHI)\nselect data_source, payer, plan, year_month, claims_with_enrollment, claims,\n  cast(claims_with_enrollment/ nullif(claims,0) as numeric) as percentage_claims_with_enrollment\nfrom ${pfx}.mart_review__claims_with_enrollment;`;
      byId('sqlConditions').textContent = `-- Chronic conditions (no PHI)\nselect data_source, condition, count(*) as count\nfrom ${pfx}.mart_review__tuva_chronic_conditions\ngroup by 1,2\norder by 3 desc;`;
      byId('sqlInpatient').textContent = `-- Inpatient LOS distribution (no PHI)\nselect data_source, payer, plan, los_groups, count(distinct encounter_id) as count\nfrom ${pfx}.mart_review__inpatient\ngroup by 1,2,3,4\norder by 4;`;
      byId('sqlEd').textContent = `-- ED avoidable categories (no PHI)\nselect data_source, avoidable_category, count(distinct encounter_id) as count, sum(paid_amount) as spend\nfrom ${pfx}.mart_review__ed_classification\ngroup by 1,2;`;
      const pfxCore = pfx.replace('_data_quality','_core');
      byId('sqlEdFacility').textContent = `-- ED spend by facility (no PHI)\nselect mc.data_source, e.facility_id, sum(mc.paid_amount) as spend, 1 as ed_flag\nfrom ${pfx}.mart_review__stg_medical_claim mc\nleft join ${pfxCore}.encounter e on mc.encounter_id = e.encounter_id and mc.data_source = e.data_source\nwhere coalesce(e.encounter_type,'') = 'emergency department'\ngroup by 1,2\norder by 3 desc;`;
      byId('sqlDrg').textContent = `-- DRG frequency (no PHI)\nselect data_source, payer, plan, drg_code, drg_description, count(distinct encounter_id) as encounters\nfrom ${pfx}.mart_review__inpatient\ngroup by 1,2,3,4,5\norder by 6 desc;`;
      byId('sqlDischarge').textContent = `-- Discharge location by facility (no PHI)\nselect data_source, facility_id, discharge_location, count(distinct encounter_id) as count\nfrom ${pfx}.mart_review__inpatient\ngroup by 1,2,3\norder by 4 desc;`;
      byId('sqlReadmit').textContent = `-- Readmission rate by month (calendar-based; no PHI)\nwith stg as (\n  select distinct data_source, payer, ${pfx.includes('"') ? '"plan"' : 'plan'} as plan, encounter_id\n  from ${pfx}.mart_review__stg_medical_claim\n), denom as (\n  select i.data_source, s.payer, s.plan, cast(cal.year_month_int as varchar) as year_month, count(*) as index_admissions\n  from ${pfx}.mart_review__inpatient i\n  left join stg s on i.data_source = s.data_source and i.encounter_id = s.encounter_id\n  left join ${pfx.replace('_data_quality','_reference_data')}.calendar cal on i.encounter_end_date = cal.full_date\n  group by 1,2,3,4\n), num as (\n  select coalesce(s.data_source,'') as data_source, s.payer, s.plan, cast(cal.year_month_int as varchar) as year_month,\n         sum(case when r.unplanned_readmit_30_flag = 1 then 1 else 0 end) as readmissions\n  from ${pfx}.mart_review__readmissions r\n  left join stg s on r.encounter_id = s.encounter_id\n  left join ${pfx.replace('_data_quality','_reference_data')}.calendar cal on r.discharge_date = cal.full_date\n  group by 1,2,3,4\n)\nselect coalesce(d.data_source,n.data_source) as data_source, coalesce(d.payer,n.payer) as payer, coalesce(d.plan, n.plan) as plan,\n       coalesce(d.year_month,n.year_month) as year_month,\n       cast(n.readmissions as double)/nullifzero(d.index_admissions) as readmission_rate\nfrom denom d full outer join num n using (data_source,payer,plan,year_month)\norder by 1,2,3,4;`;
      byId('sqlSvc').textContent = `-- Service categories (no PHI)\nselect data_source, payer, plan, year_month, service_category_1, service_category_2,\n  sum(paid_amt) as paid_amt, sum(visits) as visits\nfrom ${pfx}.mart_review__service_categories_long\ngroup by 1,2,3,4,5,6;`;
      byId('sqlEncTypes').textContent = `-- Encounter group/type paid and counts (no PHI)\nwith base as (\n  select mc.data_source, mc.payer, mc.plan, e.encounter_group, e.encounter_type,\n         count(distinct mc.encounter_id) as encounters, sum(mc.paid_amount) as paid_amount\n  from ${pfx}.mart_review__stg_medical_claim mc\n  left join ${pfx.replace('_data_quality','_core')}.encounter e\n    on mc.encounter_id = e.encounter_id and mc.data_source = e.data_source\n  group by 1,2,3,4,5\n) select * from base;`;
      byId('sqlPharm').textContent = `-- Pharmacy pivot (no PHI)\nselect p.data_source, mm.payer, mm.plan,\n  coalesce(p.atc_3_name, p.atc_2_name) as theraclass, p.ndc_code, coalesce(p.ndc_description, p.rxnorm_description) as ndc_description,\n  sum(p.paid_amount) as spend, avg(nullif(p.days_supply,0)) as avg_days_supply, avg(nullif(p.quantity,0)) as avg_quantity, avg(nullif(p.refills,0)) as avg_refills\nfrom ${pfx}.mart_review__pharmacy p\nleft join ${pfx}.mart_review__member_months mm\n  on p.person_id = mm.person_id and p.data_source = mm.data_source\ngroup by 1,2,3,4,5,6;`;
      byId('sqlHcc').textContent = `-- HCC codes (no PHI)\nselect x.data_source, f.hcc_code, count(distinct f.person_id) as count\nfrom ${pfx}.mart_review__patient_risk_factors f\nleft join ${pfx}.mart_review__patient x\n  on f.person_id = x.person_id\nwhere f.hcc_code is not null\ngroup by 1,2\norder by 3 desc;`;
    }

    function initTabs() {
      document.querySelectorAll('.tabs button').forEach(btn => {
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab-pane').forEach(p=> p.classList.remove('active'));
          byId(tab).classList.add('active');
          renderAll();
        });
      });
    }

    function loadSample() {
      // Minimal synthetic samples (no PHI) to demo layout
      const ds = 'sample_source';
      sampleLoaded = true;
      const age = `data_source,payer,plan,age_bucket,count,avg_age\n${ds},,,'00-04',100,2\n${ds},,,'05-17',200,12\n${ds},,,'18-29',300,24\n${ds},,,'30-39',250,35\n${ds},,,'40-49',220,45\n${ds},,,'50-59',210,55\n${ds},,,'60-69',150,65\n${ds},,,'70-79',120,75\n${ds},,,'80+',80,84`;
      const gender = `data_source,payer,plan,gender,count\n${ds},,,female,900\n${ds},,,male,930\n${ds},,,unknown,20`;
      const pmpm = `data_source,payer,plan,year_month,total_paid,medical_paid,pharmacy_paid\n${ds},,,202301,425,320,105\n${ds},,,202302,432,327,105\n${ds},,,202303,441,332,109\n${ds},,,202304,438,329,109`;
      const members = `data_source,year_month,members_with_claims,total_member_months,percent_members_with_claims\n${ds},202301,1200,2000,0.6\n${ds},202302,1400,2200,0.636\n${ds},202303,1500,2300,0.652\n${ds},202304,1550,2400,0.646`;
      const claimsEnroll = `data_source,payer,plan,year_month,claims_with_enrollment,claims,percentage_claims_with_enrollment\n${ds},,,202301,800,1000,0.8\n${ds},,,202302,900,1100,0.818\n${ds},,,202303,950,1200,0.792\n${ds},,,202304,1000,1250,0.8`;
      const cond = `data_source,condition,count\n${ds},Diabetes,400\n${ds},Hypertension,700\n${ds},CHF,120\n${ds},No Chronic Conditions,800`;
      const inpatient = `data_source,payer,plan,los_groups,count\n${ds},,,1. 0-1 day,120\n${ds},,,2. 2-3 days,90\n${ds},,,3. 4-5 days,70\n${ds},,,4. 6-7 days,40\n${ds},,,5. 8-14 days,20\n${ds},,,6. 15-30 days,8\n${ds},,,7. 31+ Days,4`;
      const drg = `data_source,drg_code,count\n${ds},291,40\n${ds},292,32\n${ds},641,20\n${ds},945,12`;
      const ed = `data_source,avoidable_category,count\n${ds},ED Care Needed - Not Preventable,300\n${ds},ED Care Needed - Preventable/Avoidable,80\n${ds},Primary Care Treatable,120\n${ds},Non-Emergent,60`;
      const svc = `data_source,payer,plan,year_month,service_category_1,service_category_2,paid_amt,visits\n${ds},,,202301,Inpatient,Acute,450000,120\n${ds},,,202301,Outpatient,Surgery,280000,340\n${ds},,,202301,Pharmacy,Specialty,160000,540\n${ds},,,202302,Inpatient,Acute,420000,110`;
      const hcc = `data_source,hcc_code,count\n${ds},HCC18,120\n${ds},HCC19,90\n${ds},HCC85,75\n${ds},HCC96,60`;
      const pharm = `data_source,payer,plan,theraclass,ndc_code,ndc_description,spend,avg_days_supply,avg_quantity,avg_refills\n${ds},,,Statins,0001-0001-01,Lipitor 20mg,120000,28,30,0.2\n${ds},,,Statins,0001-0002-01,Crestor 10mg,80000,28,30,0.1\n${ds},,,Diabetes,0002-0001-01,Metformin 500mg,60000,30,60,0.0`;
      const states = `data_source,payer,plan,state,count\n${ds},,,CA,1200\n${ds},,,TX,900\n${ds},,,NY,800\n${ds},,,FL,600`;
      [age,gender,pmpm,members,claimsEnroll,cond,inpatient,drg,ed,svc,hcc,pharm,states].forEach(txt=> routeCSV(txt,'sample'));
      showInfo('Sample datasets loaded.');
    }

    // init
    initTabs();
  </script>
</body>
</html>
