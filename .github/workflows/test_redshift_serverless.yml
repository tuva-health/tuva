name: Test Redshift Serverless
on:
  workflow_dispatch:
    inputs:
      run_full_build:
        description: 'Run full dbt build (vs just compile)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  AWS_REGION: us-east-1
  REDSHIFT_WORKGROUP: default-workgroup
  PYTHON_VERSION: '3.11'

jobs:
  test_redshift_serverless:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.9.4 dbt-redshift==1.9.4

      - name: Create Temporary Schema Name
        id: create-schema
        run: |
          SCHEMA_NAME="ci_test_${{ github.run_id }}"
          echo "schema_name=$SCHEMA_NAME" >> $GITHUB_OUTPUT
          echo "Using schema: $SCHEMA_NAME"

      - name: Create dbt profiles.yml using environment variables
        env:
          DBT_REDSHIFT_HOST: ${{ secrets.REDSHIFT_SERVERLESS_TEST_HOST }}
          DBT_REDSHIFT_USER: ${{ secrets.REDSHIFT_SERVERLESS_TEST_USERNAME }}
          DBT_REDSHIFT_PASSWORD: ${{ secrets.REDSHIFT_SERVERLESS_TEST_PASSWORD }}
          DBT_REDSHIFT_DATABASE: ${{ secrets.REDSHIFT_SERVERLESS_TEST_DATABASE }}
          DBT_REDSHIFT_SCHEMA: ${{ steps.create-schema.outputs.schema_name }}
        run: |
          mkdir -p ./profiles/redshift
          
          # Use Python to create the profile to avoid YAML escaping issues
          python3 << 'PYTHON_SCRIPT'
          import os
          import yaml
          
          profile = {
              'default': {
                  'outputs': {
                      'dev': {
                          'type': 'redshift',
                          'host': os.environ['DBT_REDSHIFT_HOST'],
                          'port': 5439,
                          'user': os.environ['DBT_REDSHIFT_USER'],
                          'password': os.environ['DBT_REDSHIFT_PASSWORD'],
                          'dbname': os.environ['DBT_REDSHIFT_DATABASE'],
                          'schema': os.environ['DBT_REDSHIFT_SCHEMA'],
                          'threads': 16,
                          'sslmode': 'require',
                          'connect_timeout': 30
                      }
                  },
                  'target': 'dev'
              }
          }
          
          with open('./profiles/redshift/profiles.yml', 'w') as f:
              yaml.dump(profile, f, default_flow_style=False)
          
          print("âœ… dbt profile created")
          PYTHON_SCRIPT

        working-directory: ci_testing

      - name: Verify profile was created
        run: |
          echo "Profile contents (passwords redacted):"
          cat ./profiles/redshift/profiles.yml | grep -v password
        working-directory: ci_testing

      - name: dbt deps
        run: |
          echo "Installing dbt dependencies..."
          dbt deps --profiles-dir ./profiles/redshift
        working-directory: ci_testing

      - name: dbt debug (tests connection)
        run: |
          echo "Testing dbt connection to Redshift Serverless..."
          dbt debug --profiles-dir ./profiles/redshift
          echo "âœ… Connection successful!"
        working-directory: ci_testing

      - name: dbt compile (quick test)
        if: github.event.inputs.run_full_build != 'true'
        run: |
          echo "Running dbt compile (validates SQL without executing)..."
          dbt compile --profiles-dir ./profiles/redshift --vars '{
            "use_synthetic_data": true,
            "clinical_enabled": true,
            "claims_enabled": true,
            "provider_attribution_enabled": true,
            "fhir_preprocessing_enabled": true
          }'
          echo "âœ… dbt compile successful!"
        working-directory: ci_testing

      - name: dbt build (full test)
        if: github.event.inputs.run_full_build == 'true'
        run: |
          echo "Running full dbt build..."
          echo "â±ï¸  This may take 15-30 minutes..."
          
          dbt build --full-refresh --profiles-dir ./profiles/redshift --vars '{
            "use_synthetic_data": true,
            "clinical_enabled": true,
            "claims_enabled": true,
            "provider_attribution_enabled": true,
            "fhir_preprocessing_enabled": true
          }'
          echo "âœ… dbt build successful!"
        working-directory: ci_testing

      - name: Show dbt run summary
        if: always()
        run: |
          echo "================================================"
          echo "dbt Run Summary"
          echo "================================================"
          echo "Schema used: ${{ steps.create-schema.outputs.schema_name }}"
          echo "Job status: ${{ job.status }}"
          echo "================================================"

      - name: Final Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ Redshift Serverless test PASSED!"
            echo ""
            echo "Next steps:"
            echo "1. Check AWS Cost Explorer for usage costs"
            echo "2. Compare run time to existing Redshift cluster"
            echo "3. If satisfied, update main CI workflow"
          else
            echo "âŒ Redshift Serverless test FAILED!"
            echo "Check the logs above for details"
            exit 1
          fi
