name: Test Redshift Serverless
on:
  workflow_dispatch:
    inputs:
      run_full_build:
        description: 'Run full dbt build (vs just compile)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  AWS_REGION: us-east-1
  REDSHIFT_WORKGROUP: default-workgroup
  REDSHIFT_DATABASE: ${{ secrets.REDSHIFT_SERVERLESS_TEST_DATABASE }}
  REDSHIFT_HOST: ${{ secrets.REDSHIFT_SERVERLESS_TEST_HOST }}
  PYTHON_VERSION: '3.11'

jobs:
  test_redshift_serverless:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.9.4 dbt-redshift==1.9.4

      - name: Create Temporary Schema Name
        id: create-schema
        run: |
          SCHEMA_NAME="ci_test_${{ github.run_id }}"
          echo "schema_name=$SCHEMA_NAME" >> $GITHUB_OUTPUT
          echo "Using schema: $SCHEMA_NAME"

      - name: Create dbt profiles.yml
        run: |
          mkdir -p ./profiles/redshift
          cat > ./profiles/redshift/profiles.yml << EOF
          default:
            outputs:
              dev:
                type: redshift
                host: ${{ env.REDSHIFT_HOST }}
                port: 5439
                user: ${{ secrets.REDSHIFT_SERVERLESS_TEST_USERNAME }}
                password: ${{ secrets.REDSHIFT_SERVERLESS_TEST_PASSWORD }}
                dbname: ${{ env.REDSHIFT_DATABASE }}
                schema: ${{ steps.create-schema.outputs.schema_name }}
                threads: 16
                sslmode: require
                connect_timeout: 30
            target: dev
          EOF
          
          echo "âœ… dbt profile created"
        working-directory: ci_testing

      - name: dbt deps
        run: |
          echo "Installing dbt dependencies..."
          dbt deps --profiles-dir ./profiles/redshift
        working-directory: ci_testing

      - name: dbt debug (tests connection)
        run: |
          echo "Testing dbt connection to Redshift Serverless..."
          echo "This will create the schema and test the connection"
          dbt debug --profiles-dir ./profiles/redshift
          echo "âœ… Connection successful!"
        working-directory: ci_testing

      - name: dbt compile (quick test)
        if: github.event.inputs.run_full_build != 'true'
        run: |
          echo "Running dbt compile (validates SQL without executing)..."
          dbt compile --profiles-dir ./profiles/redshift --vars '{
            "use_synthetic_data": true,
            "clinical_enabled": true,
            "claims_enabled": true,
            "provider_attribution_enabled": true,
            "fhir_preprocessing_enabled": true
          }'
          echo "âœ… dbt compile successful!"
        working-directory: ci_testing

      - name: dbt build (full test)
        if: github.event.inputs.run_full_build == 'true'
        run: |
          echo "Running full dbt build..."
          echo "â±ï¸  This may take 15-30 minutes..."
          
          dbt build --full-refresh --profiles-dir ./profiles/redshift --vars '{
            "use_synthetic_data": true,
            "clinical_enabled": true,
            "claims_enabled": true,
            "provider_attribution_enabled": true,
            "fhir_preprocessing_enabled": true
          }'
          echo "âœ… dbt build successful!"
        working-directory: ci_testing

      - name: Show dbt run summary
        if: always()
        run: |
          echo "================================================"
          echo "dbt Run Summary"
          echo "================================================"
          echo "Schema used: ${{ steps.create-schema.outputs.schema_name }}"
          echo "Job status: ${{ job.status }}"
          echo "Redshift Serverless Host: ${{ env.REDSHIFT_HOST }}"
          echo "================================================"
          echo ""
          echo "Note: Schema will remain for manual inspection."
          echo "To clean up, run in DataGrip:"
          echo "DROP SCHEMA IF EXISTS ${{ steps.create-schema.outputs.schema_name }} CASCADE;"

      - name: Final Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ Redshift Serverless test PASSED!"
            echo ""
            echo "Next steps:"
            echo "1. Check AWS Cost Explorer for usage costs"
            echo "2. Compare run time to existing Redshift cluster"
            echo "3. If satisfied, update main CI workflow"
          else
            echo "âŒ Redshift Serverless test FAILED!"
            echo "Check the logs above for details"
            exit 1
          fi
