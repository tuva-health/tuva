version: 2

models:

## Final 
  - name: pharmacy__brand_generic_opportunity
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: brand_generic_opportunity
      tags: 
        - pharmacy
      materialized: table
    description: >
      Table that identifies opportunities for generic substitution in pharmacy claims.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - data_source
            - claim_id
            - claim_line_number
    columns:
      - name: data_source
        description: Source of the data.
      - name: claim_id
        description: Unique identifier for the claim.
      - name: claim_line_number
        description: Line number of the claim.
      - name: ndc_code
        description: National Drug Code.
      - name: ndc_description
        description: Description of the drug as per NDC.
      - name: brand_rxcui
        description: RxNorm Concept Unique Identifier for the brand.
      - name: brand_vs_generic
        description: Indicates whether the drug is a brand or generic.
      - name: generic_available
        description: Indicates if a generic version is available.
      - name: paid_amount
        description: Amount paid for the drug.
      - name: total_units
        description: Total units of the drug dispensed.
      - name: brand_cost_per_unit
        description: Cost per unit for the branded drug.
      - name: generic_average_cost_per_unit
        description: Average cost per unit of the generic drug.
      - name: brand_less_generic_cost_per_unit
        description: Difference between the cost per unit of the brand and the average cost per unit of the generic drug.
      - name: generic_available_total_opportunity
        description: Total potential savings from substituting with generics, where applicable, based on units multiplied by cost difference per unit.
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: pharmacy__generic_available_list
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: generic_available_list
      tags: 
        - pharmacy
      materialized: table
    description: >
      Provides a list of pharmacy claims where a generic alternative is available, detailing both brand and potential generic drug costs and descriptions.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - generic_available_sk
            - generic_ndc
    columns:
      - name: generic_available_sk
        description: Surrogate key for generic availability.
      - name: data_source
        description: Source of the data.
      - name: brand_ndc_code
        description: National Drug Code for the brand drug.
      - name: brand_ndc_description
        description: Description of the brand drug.
      - name: brand_rxcui
        description: RxNorm Concept Unique Identifier for the brand drug.
      - name: brand_paid_amount
        description: Total amount paid for the brand drug.
      - name: brand_units
        description: Units of the brand drug dispensed.
      - name: brand_paid_per_unit
        description: Paid amount per unit for the brand drug, calculated as total paid divided by units, if units are not zero.
      - name: generic_ndc
        description: National Drug Code for the generic drug.
      - name: generic_ndc_description
        description: FDA description of the generic drug.
      - name: generic_prescribed_history
        description: Indicates if a generic version has previously been prescribed, 1 for yes and 0 for no.
      - name: generic_cost_per_unit
        description: Cost per unit for the generic drug.
      - name: generic_cost_at_units
        description: Cost for the generic drug at the dispensed units of the brand drug.
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.


  - name: pharmacy__pharmacy_claim_expanded
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: pharmacy_claim_expanded
      tags: 
        - pharmacy
      materialized: table
    description: >
      Expanded view of pharmacy claims with additional details.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - data_source
            - claim_id
            - claim_line_number
    columns:
      - name: data_source
        description: Source of the data.
      - name: claim_id
        description: Unique identifier for each pharmacy claim.
      - name: claim_line_number
        description: Line number of the claim.
      - name: patient_id
        description: Unique identifier for each patient.
      - name: member_id
        description: Unique identifier for each member.
      - name: prescribing_provider_npi
        description: NPI of the prescribing provider.
      - name: dispensing_provider_npi
        description: NPI of the dispensing provider.
      - name: dispensing_date
        description: Date when the drug was dispensed.
      - name: ndc_code
        description: National Drug Code.
      - name: ndc_description
        description: Description of the drug.
      - name: quantity
        description: Quantity of the drug dispensed.
      - name: days_supply
        description: Number of days the drug supply will last.
      - name: refills
        description: Number of refills for the drug.
      - name: paid_date
        description: Date when the drug was paid for.
      - name: paid_amount
        description: Amount paid for the drug.
      - name: allowed_amount
        description: Total allowed amount covered by insurance.
      - name: rxcui
        description: RxNorm Concept Unique Identifier.
      - name: product_name
        description: Name of the product.
      - name: product_tty
        description: Term type of the product.
      - name: brand_vs_generic
        description: Indicates whether the drug is a brand or generic.
      - name: brand_name
        description: Name of the brand.
      - name: generic_rxcui
        description: RxNorm Concept Unique Identifier for the generic version.
      - name: generic_rxcui_description
        description: Description of the generic drug.
      - name: generic_tty
        description: Term type of the generic drug.
      - name: ingredient_name
        description: Active ingredient in the drug.
      - name: dose_form_name
        description: Form of the drug dose.
      - name: generic_available
        description: Indicates if a generic version is available.
      - name: brand_cost_per_unit
        description: Cost per unit for the brand drug.
      - name: generic_average_cost_per_unit
        description: Average cost per unit of the generic drug.
      - name: brand_less_generic_cost_per_unit
        description: Difference in cost per unit between the brand and generic drug.
      - name: generic_available_total_opportunity
        description: Total potential savings from substituting with generics, where applicable, calculated per unit.
      - name: generic_available_sk
        description: Surrogate key for generic availability data.
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.


## Intermediate

  - name: pharmacy__int_brand_with_generic_available
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: _int_brand_with_generic_available
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view identifying brand drugs that have generic equivalents available.

  - name: pharmacy__int_claims_current_cost
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: _int_claims_current_cost
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view calculating the current cost of claims.

  - name: pharmacy__int_generic_cost
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: _int_generic_cost
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view calculating the cost of generic drugs.

  - name: pharmacy__int_generic_cost_by_ndc
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: _int_generic_cost_by_ndc
      tags: 
        - pharmacy
      materialized: view
    description: >
      Intermediate view calculating the cost of generic drugs at the ndc level for informational purposes.

## Staging

  - name: pharmacy__stg_pharmacy_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix', None) != None -%}
          {{var('tuva_schema_prefix')}}_pharmacy
        {% else %}
          pharmacy
        {%- endif -%}
      alias: stg_pharmacy_claim
      tags: 
        - pharmacy
      materialized: ephemeral
    description: >
      Staging table for pharmacy claims, serving as the basis for further calculations.
