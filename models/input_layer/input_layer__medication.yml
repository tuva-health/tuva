version: 2
models:
  - name: input_layer__medication
    description: |
      The medication table contains information on medications ordered and/or administered during a patient encounter.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_input_layer{% else %}input_layer{%- endif -%}
      tags: input_layer
      materialized: view
    columns:
      - name: medication_id
        description: Unique identifier for each medication in the table.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
          - unique:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
          - not_null:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: person_id
        description: Unique identifier for each person in the dataset.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - not_null:
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags:
                  - tuva_dqi_sev_2
                  - dqi
                  - dqi_quality_measures
      - name: payer
        description: 'Name of the payer (i.e. health insurer) providing coverage.'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
        config:
          meta:
            data_type: varchar
      - name: patient_id
        description: Identifier that links a patient to a particular clinical source system.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: encounter_id
        description: Unique identifier for each encounter in the dataset.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
        config:
          meta:
            data_type: varchar
      - name: dispensing_date
        description: Date the medication was dispensed.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.expect_column_values_to_be_of_type:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_2
                  - dqi
                  - dqi_quality_measures
              arguments:
                column_type: date
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.expect_column_values_to_be_between:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_3
                  - dqi
              arguments:
                min_value: '''1900-01-01'''
                max_value: '''2100-01-01'''
                strictly: false
        config:
          meta:
            data_type: date
      - name: prescribing_date
        description: Date the medication was prescribed.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.expect_column_values_to_be_of_type:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_2
                  - dqi
                  - dqi_quality_measures
              arguments:
                column_type: date
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.expect_column_values_to_be_between:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_3
                  - dqi
              arguments:
                min_value: '''1900-01-01'''
                max_value: '''2100-01-01'''
                strictly: false
        config:
          meta:
            data_type: date
      - name: source_code_type
        description: The type of code reported in the source system (e.g., ICD-10 code, NDC, lab, etc)
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - accepted_values:
              config:
                severity: warn
                tags:
                  - tuva_dqi_sev_2
                  - dqi
                  - dqi_cms_hccs
                  - dqi_quality_measures
              arguments:
                values:
                  - ndc
                  - rxnorm
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
                  - dqi_cms_hccs
        config:
          meta:
            data_type: varchar
      - name: source_code
        description: The code in the source system (e.g., the ICD-10 code, NDC, lab, etc)
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
        config:
          meta:
            data_type: varchar
      - name: source_description
        description: Description of the source code in the source system.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: ndc_code
        description: National drug code associated with the medication.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - not_null:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_3
                  - dqi
                  - dqi_quality_measures
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
        config:
          meta:
            data_type: varchar
      - name: ndc_description
        description: Description for the NDC.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: rxnorm_code
        description: RxNorm code associated with the medication.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_quality_measures
          - relationships:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_4
                  - dqi
                  - dqi_quality_measures
              arguments:
                to: ref('terminology__rxnorm_to_atc')
                field: rxcui
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
                  - dqi_quality_measures
        config:
          meta:
            data_type: varchar
      - name: rxnorm_description
        description: Description for the RxNorm code.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: atc_code
        description: ATC code for the medication.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: atc_description
        description: Description for the ATC code.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: route
        description: The route used to administer the medication and/or vaccine.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: strength
        description: The strength of the medication.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: quantity
        description: The quantity of the medication.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: number
      - name: quantity_unit
        description: The units for the quantity.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: days_supply
        description: The number of days supply included.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - not_null:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_4
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: number
      - name: practitioner_id
        description: Unique identifier for the practitioner on record (e.g., ordered medication, performed the procedure, etc).
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: data_source
        description: User-configured field that indicates the data source.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.warn_if_null_percentage_is_100:
              description: Percentage of values that are null.
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_5
                  - dqi
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: file_name
        description: The file name of the source file.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
        config:
          meta:
            data_type: varchar
      - name: ingest_datetime
        description: The date and time the source file was ingested into the data warehouse or landed in cloud storage.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
          - the_tuva_project.expect_column_values_to_be_in_type_list:
              config:
                severity: warn
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_2
                  - dqi
              arguments:
                column_type_list:
                  - date
                  - datetime
                  - time
                  - timestamp
                  - timestamp_ntz
                  - timestampntz
                  - timestamp_ltz
                  - timestampltz
                  - timestamp_tz
                  - timestamptz
                  - timestamp with time zone
                  - timestamp without time zone
                  - datetime2
                  - datetimeoffset
        config:
          meta:
            data_type: timestamp