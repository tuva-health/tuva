version: 2
models:
  - name: input_layer__observation
    description: >
      Mapping check to make sure all columns are mapped appropriately into the input
      layer.
      The observation table contains information on measurements other than lab  tests
      e.g. blood pressure, height, and weight.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_input_layer{% else %}input_layer{%- endif -%}
      tags: input_layer
      materialized: view
    columns:
      - name: observation_id
        description: '{{ doc("observation_id") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: error
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_service_categories', 'dqi_ccsr', 'dqi_cms_chronic_conditions', 'dqi_tuva_chronic_conditions', 'dqi_cms_hccs', 'dqi_ed_classification', 'dqi_financial_pmpm', 'dqi_quality_measures', 'dqi_readmission']
          - unique:
              config:
                severity: error
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_service_categories', 'dqi_ccsr', 'dqi_cms_chronic_conditions', 'dqi_tuva_chronic_conditions', 'dqi_cms_hccs', 'dqi_ed_classification', 'dqi_financial_pmpm', 'dqi_quality_measures', 'dqi_readmission']
          - not_null:
              arguments:
                column_name: observation_id
              config:
                severity: error
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_service_categories', 'dqi_ccsr', 'dqi_cms_chronic_conditions', 'dqi_tuva_chronic_conditions', 'dqi_cms_hccs', 'dqi_ed_classification', 'dqi_financial_pmpm', 'dqi_quality_measures', 'dqi_readmission']
      - name: person_id
        description: '{{ doc("person_id") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - not_null:
              arguments:
                column_name: person_id
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_2', 'dqi', 'dqi_quality_measures']
      - name: patient_id
        description: '{{ doc("patient_id") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: patient_id
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: encounter_id
        description: '{{ doc("encounter_id") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: encounter_id
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
      - name: panel_id
        description: '{{ doc("panel_id") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: panel_id
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: observation_date
        description: '{{ doc("observation_date") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.expect_column_values_to_be_of_type:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_2', 'dqi', 'dqi_quality_measures']
              arguments:
                column_type: date
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: observation_date
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.expect_column_values_to_be_between:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_3', 'dqi', 'dqi_quality_measures']
              arguments:
                min_value: '''1900-01-01'''
                max_value: '''2100-01-01'''
                strictly: false
      - name: observation_type
        description: '{{ doc("observation_type") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: observation_type
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
          - accepted_values:
              config:
                severity: warn
                tags: ['tuva_dqi_sev_2', 'dqi']
              arguments:
                values: ['social-history', 'vital-signs', 'imaging', 'laboratory', 'procedure', 'survey', 'exam', 'therapy', 'activity', 'other']
      - name: source_code_type
        description: '{{ doc("source_code_type") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_cms_hccs', 'dqi_quality_measures']
          - accepted_values:
              config:
                severity: warn
                tags: ['tuva_dqi_sev_2', 'dqi', 'dqi_cms_hccs', 'dqi_quality_measures']
              arguments:
                values: ['icd-10-cm', 'icd-9-cm', 'snomed-ct', 'hcpcs', 'icd-10-pcs', 'icd-9-pcs', 'loinc']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: source_code_type
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures', 'dqi_cms_hccs']
      - name: source_code
        description: '{{ doc("source_code") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: source_code
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
      - name: source_description
        description: '{{ doc("source_description") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: source_description
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: normalized_code_type
        description: '{{ doc("normalized_code_type") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: normalized_code_type
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
      - name: normalized_code
        description: '{{ doc("normalized_code") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: normalized_code
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
      - name: normalized_description
        description: '{{ doc("normalized_description") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: normalized_description
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
      - name: result
        description: '{{ doc("result") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi', 'dqi_quality_measures']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: result
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi', 'dqi_quality_measures']
      - name: source_units
        description: '{{ doc("source_units") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: source_units
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: normalized_units
        description: '{{ doc("normalized_units") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: normalized_units
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: source_reference_range_low
        description: '{{ doc("source_reference_range_low") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: source_reference_range_low
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: source_reference_range_high
        description: '{{ doc("source_reference_range_high") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: source_reference_range_high
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: normalized_reference_range_low
        description: '{{ doc("normalized_reference_range_low") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: normalized_reference_range_low
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: normalized_reference_range_high
        description: '{{ doc("normalized_reference_range_high") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: normalized_reference_range_high
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: data_source
        description: '{{ doc("data_source") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.warn_if_null_percentage_above_zero:
              arguments: 
                column_name: data_source
              description: "Percentage of values that are null."
              config:
                severity: warn
                enabled: "{{ var('enable_input_layer_testing', true) | as_bool }}"
                tags: ['tuva_dqi_sev_5', 'dqi']
      - name: file_name
        description: '{{ doc("file_name") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
      - name: ingest_datetime
        description: '{{ doc("ingest_datetime") }}'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_1', 'dqi']
          - the_tuva_project.expect_column_values_to_be_in_type_list:
              config:
                severity: warn
                enabled: "{{ (var('enable_input_layer_testing', true)) | as_bool }}"
                tags: ['tuva_dqi_sev_2', 'dqi']
              arguments:
                column_type_list: [date, datetime, time, timestamp, timestamp_ntz, timestampntz, timestamp_ltz, timestampltz, timestamp_tz, timestamptz, timestamp with time zone, timestamp without time zone, datetime2, datetimeoffset]