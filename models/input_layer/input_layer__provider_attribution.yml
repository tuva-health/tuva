version: 2
models:
  - name: input_layer__provider_attribution
    description: |
      The provider_attribution table assigns a provider to each patient-member_month of eligibility. The user may 
      assign both a payer attributed provider (as typically assigned by the payer in VBC contracts) as well as custom 
      attributed provider (typically determined by the user). Fields related to each attributed provider (practice, 
      organization, line of business) are also present.  This table allows you to input a custom attribution assigment from 
      another system.  You can also use the Provider Attribution data mart to do this assignment by using your claims data.
    tests:
      - dbt_utils.unique_combination_of_columns:
          config:
            severity: error
            enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
            tags:
              - tuva_dqi_sev_1
              - dqi
              - dqi_service_categories
              - dqi_ccsr
              - dqi_cms_chronic_conditions
              - dqi_tuva_chronic_conditions
              - dqi_cms_hccs
              - dqi_ed_classification
              - dqi_financial_pmpm
              - dqi_quality_measures
              - dqi_readmission
          arguments:
            combination_of_columns:
              - person_id
              - member_id
              - payer
              - '{{ ''"plan"'' if (target.type == ''fabric'') else ''plan'' }}'
              - year_month
              - data_source
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_input_layer{% else %}input_layer{%- endif -%}
      tags: input_layer
      materialized: view
    columns:
      - name: person_id
        description: Unique identifier for each person in the dataset.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: error
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
          - not_null:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: patient_id
        description: Identifier that links a patient to a particular clinical source system.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: member_id
        description: 'Identifier that links a patient to a particular insurance product or health plan. A patient can have more than one member_id because they can have more than one insurance product/plan.'
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
          - not_null:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: year_month
        description: Unique year-month in the dataset computed from eligibility.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: error
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
          - not_null:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: payer
        description: Name of the payer (i.e. health insurer) providing coverage.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: plan
        description: Name of the plan (i.e. sub contract) providing coverage.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: data_source
        description: User-configured field that indicates the data source.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: error
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
          - not_null:
              config:
                severity: error
                enabled: '{{ var(''enable_input_layer_testing'', true) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_service_categories
                  - dqi_ccsr
                  - dqi_cms_chronic_conditions
                  - dqi_tuva_chronic_conditions
                  - dqi_cms_hccs
                  - dqi_ed_classification
                  - dqi_financial_pmpm
                  - dqi_quality_measures
                  - dqi_readmission
        config:
          meta:
            data_type: varchar
            is_primary_key: true
      - name: payer_attributed_provider
        description: Unique identifier for the provider assigned to this patient-year_month by the payer.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: payer_attributed_provider_practice
        description: Name of the practice for the payer attributed provider.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: payer_attributed_provider_organization
        description: Name of the organization for the payer attributed provider.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: payer_attributed_provider_lob
        description: Name of the line of business for the payer attributed provider (e.g. medicare, medicaid, commercial).
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: custom_attributed_provider
        description: Unique identifier for the provider assigned to this patient-year_month by the user.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: custom_attributed_provider_practice
        description: Name of the practice for the attributed provider assigned by the user.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: custom_attributed_provider_organization
        description: Name of the organization for the attributed provider assigned by the user.
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
      - name: custom_attributed_provider_lob
        description: Name of the line of business for the attributed provider assigned by the user (e.g. medicare, medicaid, commercial).
        tests:
          - the_tuva_project.expect_column_to_exist:
              config:
                severity: warn
                enabled: '{{ (var(''enable_input_layer_testing'', true)) | as_bool }}'
                tags:
                  - tuva_dqi_sev_1
                  - dqi
                  - dqi_financial_pmpm
        config:
          meta:
            data_type: varchar
