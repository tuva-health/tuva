version: 2

models:

## Final 
  - name: ahrq_measures__pqi_denom_long
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: pqi_denom_long
      tags: 
        - ahrq_measures
        - pqi
      materialized: table
    description: >
      Long table that unions the denominator for all the PQI measures.
    columns:
      - name: year_number
        description: the year the patient qualified for the corresponding denominator
      - name: patient_id
        description: Unique identifier for each patient in the dataset.
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: pqi_number
        description: the number of the pqi measure
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: ahrq_measures__pqi_exclusion_long
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: pqi_exclusion_long
      tags: 
        - ahrq_measures
        - pqi
      materialized: table
    description: >
      Long table that unions the exclusions for all the PQI measures.
    columns:
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: encounter_id
        description: Unique identifier for each encounter.
      - name: exclusion_reason
        description: description of the reason the encounter was excluded
      - name: exclusion_number
        description: for a given encounter and pqi measure, the number of exclusion it qualifies for. 
      - name: pqi_number
        description: the number of the pqi measure
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: ahrq_measures__pqi_num_long
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: pqi_num_long
      tags: 
        - ahrq_measures
        - pqi
      materialized: table
    description: >
      Long table that unions the numerator for all the PQI measures.
    columns:
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: patient_id
        description: Unique identifier for each patient in the dataset.
      - name: year_number
        description: the year the patient qualified for the corresponding numerator
      - name: encounter_id
        description: Unique identifier for each encounter.
      - name: exclusion_number
        description: for a given encounter and pqi measure, the number of exclusion it qualifies for. 
      - name: pqi_number
        description: the number of the pqi measure
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: ahrq_measures__pqi_rate
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: pqi_rate
      tags: 
        - ahrq_measures
        - pqi
      materialized: table
    description: >
      Table that combines numerator and denominator and calculates a rate per 100k
    columns:
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: year_number
        description: the year the patient qualified for the corresponding numerator
      - name: pqi_number
        description: the number of the pqi measure
      - name: denom_count
        description: the count of patients that qualified for the denominator of the corresponding year and pqi number.
      - name: num_count
        description: the count of patients that qualified for the numerator of the corresponding year and pqi number.
      - name: rate_per_100_thousand
        description: the calculated rate per 100 thousand (numerator divided by denominator, multiplied by 100000)
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: ahrq_measures__pqi_summary
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: pqi_summary
      tags: 
        - ahrq_measures
        - pqi
      materialized: table
    description: >
      Summary table for pqi numerators that bring in encounter details for analytics reporting.
    columns:
      - name: pqi_number
        description: the number of the pqi measure
      - name: pqi_name
        description: the name of the pqi measure
      - name: year_number
        description: the year the patient qualified for the corresponding numerator
      - name: encounter_id
        description: Unique identifier for each encounter.
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: year_number
        description: the year the patient qualified for the corresponding numerator
      - name: patient_id
        description: Unique identifier for each patient in the dataset.
      - name: facility_npi
        description: >
          Facility NPI for the encounter (typically represents the facility 
          where services were performed).      
      - name: ms_drg_code
        description: MS-DRG code for the encounter.
      - name: ms_drg_description
        description: Description of the ms_drg_code.
      - name: encounter_start_date
        description: Date when the encounter started.
      - name: encounter_end_date
        description: Date when the encounter ended.
      - name: length_of_stay
        description: >
          Length of the encounter calculated as encounter_end_date - 
          encounter_start_date.
      - name: paid_amount
        description: The total amount paid for the encounter by the insurer.
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

## Intermediate

  - name: ahrq_measures__int_pqi_01_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_01_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 01 measure calculation.

  - name: ahrq_measures__int_pqi_01_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_01_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 01 measure.

  - name: ahrq_measures__int_pqi_01_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_01_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 01 measure calculation.

  - name: ahrq_measures__int_pqi_03_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_03_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 03 measure calculation.

  - name: ahrq_measures__int_pqi_03_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_03_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 03 measure.

  - name: ahrq_measures__int_pqi_03_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_03_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 03 measure calculation.

  - name: ahrq_measures__int_pqi_05_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_05_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 05 measure calculation.
    
  - name: ahrq_measures__int_pqi_05_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_05_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 05 measure.

  - name: ahrq_measures__int_pqi_05_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_05_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 05 measure calculation.
    
  - name: ahrq_measures__int_pqi_07_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_07_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 07 measure calculation.

  - name: ahrq_measures__int_pqi_07_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_07_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 07 measure.

  - name: ahrq_measures__int_pqi_07_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_07_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 07 measure calculation.
    
  - name: ahrq_measures__int_pqi_08_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_08_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 08 measure calculation.

  - name: ahrq_measures__int_pqi_08_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_08_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 08 measure.

  - name: ahrq_measures__int_pqi_08_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_08_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 08 measure calculation.

  - name: ahrq_measures__int_pqi_11_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_11_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 11 measure calculation.
    
  - name: ahrq_measures__int_pqi_11_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_11_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 11 measure.

  - name: ahrq_measures__int_pqi_11_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_11_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 11 measure calculation.

  - name: ahrq_measures__int_pqi_12_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_12_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 12 measure calculation.

  - name: ahrq_measures__int_pqi_12_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_12_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 12 measure.

  - name: ahrq_measures__int_pqi_12_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_12_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 12 measure calculation.

  - name: ahrq_measures__int_pqi_14_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_14_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 14 measure calculation.
    
  - name: ahrq_measures__int_pqi_14_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_14_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 14 measure.

  - name: ahrq_measures__int_pqi_14_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_14_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 14 measure calculation.

  - name: ahrq_measures__int_pqi_15_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_15_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 15 measure calculation.

  - name: ahrq_measures__int_pqi_15_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_15_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 15 measure.

  - name: ahrq_measures__int_pqi_15_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_15_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 15 measure calculation.

  - name: ahrq_measures__int_pqi_16_denom
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_16_denom
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Denominator for PQI 16 measure calculation.

  - name: ahrq_measures__int_pqi_16_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_16_exclusions
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic specific to PQI 16 measure.

  - name: ahrq_measures__int_pqi_16_num
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_16_num
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Numerator for PQI 16 measure calculation.
    
  - name: ahrq_measures__int_pqi_shared_exclusion_missing_age
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusions_missing_age
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Exclusion logic for patients without an age

  - name: ahrq_measures__int_pqi_shared_exclusion_missing_dates
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusion_missing_dates
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Handles missing date fields across various PQI measures.

  - name: ahrq_measures__int_pqi_shared_exclusion_missing_gender
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusion_missing_gender
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Handles missing gender information for PQI measures.

  - name: ahrq_measures__int_pqi_shared_exclusion_missing_primary_dx
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusion_missing_primary_dx
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Handles cases with missing primary diagnosis in PQI measure calculations.

  - name: ahrq_measures__int_pqi_shared_exclusion_transfer
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusion_transfer
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Excludes transferred patients from PQI calculations.

  - name: ahrq_measures__int_pqi_shared_exclusion_ungroupable_drg
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusion_ungroupable_drg
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Excludes patients with ungroupable DRGs from PQI measures.

  - name: ahrq_measures__int_pqi_shared_exclusion_union
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _int_pqi_shared_exclusion_union
      tags: 
        - ahrq_measures
        - pqi
      materialized: view
    description: >
      Union of all exclusion criteria used across PQI measures for consistent exclusion logic.

## Staging

  - name: ahrq_measures__stg_pqi_inpatient_encounter
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _stg_pqi_inpatient_encounter
      tags: 
        - ahrq_measures
        - pqi
      materialized: ephemeral
    description: >
      Staging table for PQI inpatient encounters, serving as the basis for further PQI measure calculations.

  - name: ahrq_measures__stg_pqi_condition
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _stg_pqi_condition
      tags: 
        - ahrq_measures
        - pqi
      materialized: ephemeral
    description: >
      Staging table for PQI condition, from core.condition.

  - name: ahrq_measures__stg_pqi_member_months
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _stg_pqi_member_months
      tags: 
        - ahrq_measures
        - pqi
      materialized: ephemeral
    description: >
      Staging table for PQI member months, from financial_pmpm__member_months.

  - name: ahrq_measures__stg_pqi_patient
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _stg_pqi_patient
      tags: 
        - ahrq_measures
        - pqi
      materialized: ephemeral
    description: >
      Staging table for PQI patient, from core.patient.

  - name: ahrq_measures__stg_pqi_procedure
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ahrq_measures{% else %}ahrq_measures{%- endif -%}
      alias: _stg_pqi_procedure
      tags: 
        - ahrq_measures
        - pqi
      materialized: ephemeral
    description: >
      Staging table for PQI condition, from core.procedure.
