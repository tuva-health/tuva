version: 2

models:
  - name: hcc_recapture__recapture_rates
    description: HCC recapture rates by payment year.
    config:
      schema: hcc_recapture
      alias: recapture_rates
      tags: ["hcc_recapture", "final"]
      materialized: table
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - payer
            - payment_year
    columns:
      - name: payer
        description: The name of the person (i.e. beneficiary) insurance provider.  
      - name: payment_year
        description: >
          This is the year that the HCC should be coded. Typically the collection year + 1, but for open HCCs it will be the collection year + 2. 
          To illustrate, if we have an HCC claim in 2023, but not in 2024, that means it is open in 2024. The payment year is 2024 + 1 = 2025. So 
          an open HCC from 2023 will have a payment year = 2025.       
      - name: closed_hccs
        description: The number of HCCs that were closed in the payment year. See the definition of closed HCCs in the gap_status field in the gap_status model.
      - name: open_hccs
        description: The number of HCCs that are open in the payment year. See the definition of open HCCs in the gap_status field in the gap_status model.
      - name: total_hccs
        description: The total number of HCCs that were open or closed in the payment year. Excludes new and inappropriate for recapture HCCs.
      - name: recapture_rate
        description: Closed HCCs divided by Total HCCs in the given payment year.
  - name: hcc_recapture__recapture_rates_monthly
    description: HCC recapture rates by payment year month.
    config:
      schema: hcc_recapture
      alias: recapture_rates_monthly
      tags: ["hcc_recapture", "final"]
      materialized: table
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - payer
            - payment_year
            - payment_year_month
    columns:
      - name: payer
        description: The name of the person (i.e. beneficiary) insurance provider.
      - name: payment_year
        description: >
          This is the year that the HCC should be coded. Typically the collection year + 1, but for open HCCs it will be the collection year + 2. 
          To illustrate, if we have an HCC claim in 2023, but not in 2024, that means it is open in 2024. The payment year is 2024 + 1 = 2025. So 
          an open HCC from 2023 will have a payment year = 2025.       
      - name: payment_year_month
        description: >
          The month in the collection year that the HCC was closed. Collection year month is not used since this differs for open vs closed HCCs, but payment year month
          will be the same for both open and closed HCCs.
      - name: closed_hccs
        description: The number of HCCs that were closed the payment month. See the definition of closed HCCs in the gap_status field in the gap_status model.
      - name: open_hccs
        description: The number of HCCs that are open in the payment month. See the definition of open HCCs in the gap_status field in the gap_status model.
      - name: total_hccs
        description: The total number of HCCs that were open or closed in the payment month. Excludes new and inappropriate for recapture HCCs.
      - name: recapture_rate
        description: Closed HCCs divided by Total HCCs in the given payment month.
  - name: hcc_recapture__recapture_rates_monthly_ytd
    description: HCC recapture rates by payment month year-to-date.
    config:
      schema: hcc_recapture
      alias: recapture_rates_monthly_ytd
      tags: ["hcc_recapture", "final"]
      materialized: table
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - payer
            - payment_year
            - payment_year_month
    columns:
      - name: payer
        description: The name of the person (i.e. beneficiary) insurance provider.
      - name: payment_year
        description: >
          This is the year that the HCC should be coded. Typically the collection year + 1, but for open HCCs it will be the collection year + 2. 
          To illustrate, if we have an HCC claim in 2023, but not in 2024, that means it is open in 2024. The payment year is 2024 + 1 = 2025. So 
          an open HCC from 2023 will have a payment year = 2025.   
      - name: payment_year_month
        description: >
          The month in the collection year that the HCC was closed. Collection year month is not used since this differs for open vs closed HCCs, but payment year month
          will be the same for both open and closed HCCs.
      - name: monthly_closed_hccs
        description: The number of HCCs that were closed the payment month. See the definition of closed HCCs in the gap_status field in the gap_status model.
      - name: monthly_open_hccs
        description: The number of HCCs that are open in the payment month. See the definition of open HCCs in the gap_status field in the gap_status model.
      - name: monthly_total_hccs
        description: The total number of HCCs that were open or closed in the payment month. Excludes new and inappropriate for recapture HCCs.
      - name: monthly_recapture_rate
        description: Closed HCCs divided by Total HCCs in the given payment month.
      - name: ytd_closed_hccs
        description: The number of HCCs that were closed the payment month + all prior payment months in the payment year. See the definition of closed HCCs in the gap_status field in the gap_status model.
      - name: ytd_open_hccs
        description: The number of HCCs that are open in the payment month + all prior payment months in the payment year. See the definition of open HCCs in the gap_status field in the gap_status model.
      - name: yearly_total_hccs
        description: The number of HCCs open and closed in a payment year.
      - name: ytd_recapture_rate
        description: The running total of closed HCCs divided by total HCCs in a payment year.
  - name: hcc_recapture__hcc_status
    description: Combines claims data with HCC gap status.
    config:
      schema: hcc_recapture
      alias: hcc_status
      tags: ["hcc_recapture", "final"]
      materialized: table
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - person_id
            - payer
            - data_source
            - payment_year
            - recorded_date
            - claim_id
            - hcc_code
            - rendering_npi
            - model_version
            - hcc_hierarchy_group
            - hcc_hierarchy_group_rank
    columns:
      - name: person_id
        description: A unique identifier for a person.
      - name: payer
        description: The name of the person (i.e. beneficiary) insurance provider.
      - name: data_source
        description: The name of the data source origin. Filled in by the user in the input layer files.
      - name: payment_year
        description: >
          This is the year that the HCC should be coded. Typically the collection year + 1, but for open HCCs it will be the collection year + 2. 
          To illustrate, if we have an HCC claim in 2023, but not in 2024, that means it is open in 2024. The payment year is 2024 + 1 = 2025. So 
          an open HCC from 2023 will have a payment year = 2025.   - name: payment_year
      - name: recorded_date
        description: The date the claim was originally recorded. Based on admission date, but if null then filled in by claim start date followed by claim end date.
      - name: claim_id
        description: A unique identifier for the claim.
      - name: rendering_npi
        description: The National Provider Identifier (NPI) of the physician who rendered services to the beneficiary.
      - name: model_version
        description: >
          The CMS Medicare risk model version. This includes models such as v22,v24, and v28 which are documented in the 
          yearly rate announcement (e.g. https://www.cms.gov/files/document/2026-announcement.pdf) and on the CMS risk adjustment 
          website: https://www.cms.gov/medicare/payment/medicare-advantage-rates-statistics/risk-adjustment    
      - name: hcc_code
        description: The hierarchical condition category code.
      - name: hcc_description
        description: A description of the HCC code.
      - name: hcc_hierarchy_group
        description: >
          The name of the HCC hierarchy group. Determined based off of the CMS risk adjustment website model software.
          For example, in 2025, the hierarchies were stored in a file called `V28115H1.txt`. The file will end in an H.
      - name: hcc_hierarchy_group_rank
        description: >
          The rank within the HCC hierarchy group. The lower the number, the higher the rank. When 2 HCCs within the same group are 
          coded within the same collection year, the HCC with the lower rank will be chosen of the two for a given beneficiary.
      - name: risk_model_code
        description: >
          There are different coefficients depending on a few factors such as dual eligibility, new enrollee, institutional status, etc...
          This column provides acronyms based off of the CMS risk adjustment SAS code. For example, these can be found in the `C2824T2N_25.csv` file for
          the 2025 CMS risk adjustment software.     
      - name: eligible_claim_indicator
        description: >
          Whether the claim is eligible for risk adjustment as determined based on a list of accepted CPT/HCPCs codes from CMS. These are available
          on the CMS risk adjustment website: https://www.cms.gov/medicare/payment/medicare-advantage-rates-statistics/risk-adjustment
      - name: eligible_bene
        description: A 1 is indicated for a beneficiary who is in the eligibility files. A 0 is indicated if they are not in the eligibility files.
      - name: reason
        description: Free text reason for the appointment or service.
      - name: gap_status
        desription: >
          definitions for gap_status:
            - 'closed using higher coefficient hcc in hierarchy group': An HCC in the same group was closed, but its coefficient is greater than the prior year HCC
            - 'closed': the specific HCC in question has been observed in a risk adjustable claim during the collection year.
            - 'closed using lower coefficient hcc in hierarchy group': An HCC in the same group was closed, but its coefficient is less than the prior year HCC
            - 'new': defined as an hcc that has not been coded in the past 2 years
            - 'open': for gaps and claims, it's a chronic condition appropriate for recapture that has not been documented in current collection year
            - 'inappropriate for recapture': the specific HCC in question is “Open” and no related/equivalent HCC has been closed, but it is not appropriate for risk adjustment because it’s not a chronic diagnosis.
      - name: recapture_flag
        description: > 
          Whether or not the HCC is recapturable. Includes the following values:
            - 'Y': condition is a chronic condition appropriate for recapture and has been documented in the prior 2 years
            - 'N': condition is not a chronic condition appropriate for recapture or has not been documented in the prior 2 years      
  - name: hcc_recapture__gap_status
    description: The gap status for each HCC.
    config:
      schema: hcc_recapture
      alias: gap_status
      tags: ["hcc_recapture", "final"]
      materialized: table  
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - person_id
            - hcc_code
            - payer
            - model_version
            - payment_year
            - suspect_hcc_flag
    columns:
      - name: person_id
        description: A unique identifier for a person.
      - name: payer
        description: The name of the person (i.e. beneficiary) insurance provider.
      - name: hcc_code
        description: The hierarchical condition category code.
      - name: risk_model_code
        description: >
          There are different coefficients depending on a few factors such as dual eligibility, new enrollee, institutional status, etc...
          This column provides acronyms based off of the CMS risk adjustment SAS code. For example, these can be found in the `C2824T2N_25.csv` file for
          the 2025 CMS risk adjustment software.
      - name: model_version
        description: >
          The CMS Medicare risk model version. This includes models such as v22,v24, and v28 which are documented in the 
          yearly rate announcement (e.g. https://www.cms.gov/files/document/2026-announcement.pdf) and on the CMS risk adjustment 
          website: https://www.cms.gov/medicare/payment/medicare-advantage-rates-statistics/risk-adjustment.
      - name: payment_year
        description: >
          This is the year that the HCC should be coded. Typically the collection year + 1, but for open HCCs it will be the collection year + 2. 
          To illustrate, if we have an HCC claim in 2023, but not in 2024, that means it is open in 2024. The payment year is 2024 + 1 = 2025. So 
          an open HCC from 2023 will have a payment year = 2025.
      - name: recapture_flag
        description: > 
          Whether or not the HCC is recapturable. Includes the following values:
            - 'Y': condition is a chronic condition appropriate for recapture and has been documented in the prior 2 years
            - 'N': condition is not a chronic condition appropriate for recapture or has not been documented in the prior 2 years- name: recapture_flag
      - name: gap_status
        desription: >
          definitions for gap_status:
            - 'closed using higher coefficient hcc in hierarchy group': An HCC in the same group was closed, but its coefficient is greater than the prior year HCC
            - 'closed': the specific HCC in question has been observed in a risk adjustable claim during the collection year.
            - 'closed using lower coefficient hcc in hierarchy group': An HCC in the same group was closed, but its coefficient is less than the prior year HCC
            - 'new': defined as an hcc that has not been coded in the past 2 years
            - 'open': for gaps and claims, it's a chronic condition appropriate for recapture that has not been documented in current collection year
            - 'inappropriate for recapture': the specific HCC in question is “Open” and no related/equivalent HCC has been closed, but it is not appropriate for risk adjustment because it’s not a chronic diagnosis.      
            