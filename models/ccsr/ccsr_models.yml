version: 2

models:

### Intermediate

  - name: ccsr__dx_vertical_pivot
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ccsr
        {% else %}ccsr{%- endif -%}
      alias: dx_vertical_pivot
      tags:
        - ccsr
      materialized: table
    description: |
      This is an intermediate model that pivots the DXCCSR's wide-format mapping CSV
      into a long format table. While the seed uses 6 columns to represent the 6 CCSR codes that
      may be present, this generates one row for each CCSR category per ICD code, so up to
      6 rows per code. 

      This model includes details and descriptions of the CCSR parent category and body systems that are inherited by the final models.

      This model may also be useful in looking up CCSR condition category, body system, and parent category information.
    columns:
      - name: code
        description: The ICD-10-CM code
      - name: code_description
        description: The description of the ICD-10-CM code included in the seed file.
      - name: ccsr_category
        description: "A CCSR category for the ICD-10-CM code. One ICD-10-CM code may have up
          6 CCSR categories associated, ordinally ranked by the ccsr_category_rank.
          Will be null if a record has a `code` that isn't referenced in the CCSR seed file."
      - name: ccsr_category_rank
        description: "The ordinal rank of a given CCSR category mapped to an ICD-10-CM code. The
          CCSR seed CSV has the order of categories assigned to each ICD-10-CM code."
      - name: ccsr_category_description
        description: The human readable description of the `ccsr_category`.
      - name: ccsr_parent_category
        description: The CCSR parent category - the three letter prefix for each alphanumeric category.
      - name: is_ip_default_category
        description: "For each ICD-10-CM code, this field will return true for the CCSR category
          that is the default value for the code if the underlying record is an inpatient encounter."
      - name: is_op_default_category
        description: "For each ICD-10-CM code, this field will return true for the CCSR category
          that is the default value for the code if the underlying record is an outpatient encounter."
      - name: tuva_last_run
        description: The time at with the model was materialized. Generated by `dbt_utils.pretty_time` as the local time of the `dbt run` environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: ccsr__procedure_category_map
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ccsr
        {% else %}ccsr{%- endif -%}
      alias: procedure_category_map
      tags:
        - ccsr
      materialized: table
    description: This is an intermediate model that renames some PRCCSR columns to align with other TUVA
      models as well as the `ccsr__dx_vertical_pivot` model.
    columns:
      - name: code
        description: The ICD-10-PCS code
      - name: code_description
        description: The description of the ICD-10-PCS code included in the seed file.
      - name: ccsr_category
        description: The CCSR category to which the ICD-10 code is mapped.
      - name: ccsr_category_description
        description: A description of the CCSR category.
      - name: clinical_domain
        description: The clinical domain to which the CCSR code belongs. Note that the condition models don't have this column, but
          the `body_system` is a conceptually related column in the condition tables.
      - name: ccsr_parent_category
        description: The CCSR parent category - the three letter prefix for each alphanumeric category.
      - name: tuva_last_run
        description: The time at with the model was materialized. Generated by `dbt_utils.pretty_time` as the local time of the `dbt run` environment.  Timezone is configurable via the `tuva_last_run` var.

### Final

  - name: ccsr__long_condition_category
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ccsr
        {% else %}ccsr{%- endif -%}
      alias: long_condition_category
      tags:
        - ccsr
      materialized: table
    description: This model contains a mapping of individual condition ICD-10-CM diagnosis codes to the
      CCSR's clinically meaningful diagnosis categories. Each row represents a mapping of an ICD-10 code
      to a CCSR category. As each ICD-10 code may be mapped to up to 6 categories, it's expected
      that this table will output as many or more rows than the TUVA condition model.
      The model is equivalent to the CCSR's Output Option 1 - Vertical File Output.
    columns:
      - name: encounter_id
        description: Unique identifier for each the encounter.
      - name: claim_id
        description: Unique identifier for each claim.
      - name: patient_id
        description: Unique identifier for each patient.
      - name: normalized_code
        description: "The ICD-10-CM code for the diagnosis."
        meta:
          terminology: https://github.com/tuva-health/the_tuva_project/blob/main/seeds/terminology/terminology__icd_10_cm.csv
          terminology_note: "**Note: this terminology set is too large to be loaded as a seed and is instead loaded from public cloud storage for supported adapters."
      - name: code_description
        description: "The ICD-10-CM code description provided in the CCSR CSV seed file."
      - name: condition_rank
        description: The numerical ranking of a diagnosis code in a claim.
        data_type: integer
      - name: body_system
        description: The body system to which each parent category belongs. The 22 body systems generally follow the structure of the ICD-10-CM diagnosis chapters.
          Note that the procedure tables don't have this column, but a conceptually related field in procedure models is `clinical_domain`.
      - name: ccsr_parent_category
        description: The parent category code for each CCSR category. In practice, this is the three letter prefix to the category code.
      - name: parent_category_description
        description: A description of the parent category.
      - name: ccsr_category
        description: "A CCSR category for the ICD-10-CM code. One ICD-10-CM code may have up
          6 CCSR categories associated, ordinally ranked by the ccsr_category_rank.
          Will be null if a record has a `code` that isn't referenced in the CCSR seed file."
      - name: ccsr_category_description
        description: "The description of the CCSR category as provided in the CCSR seed file."
      - name: ccsr_category_rank
        description: "The ordinal rank of a given CCSR category mapped to an ICD-10-CM code. The
          CCSR seed CSV has the order of categories assigned to each ICD-10-CM code."
      - name: is_ip_default_category
        description: "For each ICD-10-CM code, this field will return true for the CCSR category
          that is the default value for the code if the underlying record is an inpatient encounter."
      - name: is_op_default_category
        description: "For each ICD-10-CM code, this field will return true for the CCSR category
          that is the default value for the code if the underlying record is an outpatient encounter."
      - name: dxccsr_version
        description: The version number of the CCSR program from which the dbt model was derived.
      - name: tuva_last_run
        description: The time at with the model was materialized. Generated by `dbt_utils.pretty_time` as the local time of the `dbt run` environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: ccsr__singular_condition_category
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ccsr
        {% else %}ccsr{%- endif -%}
      alias: singular_condition_category
      tags:
        - ccsr
      materialized: table
    description: This model contains only the CCSR's default category assignment for the ICD-10 code,
      and only for the first-listed ICD-10 code (`diagnosis_code = 1`).
    columns:
      - name: encounter_id
        description: Unique identifier for an encounter.
      - name: claim_id
        description: Unique claim_id for each claim.
        tests:
          - not_null:
              config:
                severity: warn
          - unique:
              config:
                severity: warn
      - name: patient_id
        description: Unique identifier for each patient.
      - name: body_system
        description: The body system to which each parent category belongs. The 22 body systems generally follow the structure of the ICD-10-CM diagnosis chapters.
          Note that the procedure tables don't have this column, but a conceptually related field in procedure models is `clinical_domain`.
      - name: ccsr_parent_category
        description: The parent category code for each CCSR category. In practice, this is the three letter prefix to the category code.
      - name: parent_category_description
        description: A description of the parent category.
      - name: ccsr_category
        description: "A CCSR category for the ICD-10-CM code. One ICD-10-CM code may have up
          6 CCSR categories associated, ordinally ranked by the ccsr_category_rank.
          Will be null if a record has a `code` that isn't referenced in the CCSR seed file."
      - name: ccsr_category_description
        description: The human readable description of the `ccsr_category`.
      - name: dxccsr_version
        description: The version number of the CCSR program from which the dbt model was derived.
      - name: tuva_last_run
        description: The time at with the model was materialized. Generated by `dbt_utils.pretty_time` as the local time of the `dbt run` environment.  Timezone is configurable via the `tuva_last_run` var.


  - name: ccsr__long_procedure_category
    description: This model contains a mapping of individual condition ICD-10-PCS procedure codes to the
      CCSR's clinically meaningful procedure categories. Each row represents a mapping of an ICD-10 code
      to a CCSR category. The model is equivalent to the CCSR's Output Option 1 - Vertical File Output.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ccsr
        {% else %}ccsr{%- endif -%}
      alias: long_procedure_category
      tags:
        - ccsr
      materialized: table
    columns:
      - name: encounter_id
        description: The encounter_id for the encounter where this procedure was performed.
      - name: patient_id
        description: Unique identifier for each patient.
      - name: normalized_code
        description: The ICD-10-PCS code for the procedure.
        meta:
          terminology: https://github.com/tuva-health/the_tuva_project/blob/main/seeds/terminology/terminology__icd_10_pcs.csv
          terminology_note: "**Note: this terminology set is too large to be loaded as a seed and is instead loaded from public cloud storage for supported adapters."
      - name: code_description
        description: "The ICD-10-PCS code description provided in the CCSR CSV seed file."
      - name: ccsr_parent_category
        description: The parent category code for each CCSR category. In practice, this is the three letter prefix to the category code.
      - name: clinical_domain
        description: The ICD-10-PCS Clinical Domain that the CCSR parent category belongs to. Note that the condition models don't have this column, but
          the `body_system` is a conceptually related column in the condition tables.
      - name: ccsr_category_description
        description: A description of the clinical domain.
      - name: ccsr_category
        description: The CCSR category mapped to the ICD-10-PCS code.
      - name: prccsr_version
        description: The version number of the CCSR program from which the dbt model was derived.
      - name: tuva_last_run
        description: The time at with the model was materialized. Generated by `dbt_utils.pretty_time` as the local time of the `dbt run` environment.  Timezone is configurable via the `tuva_last_run` var.


## Staging

  - name: ccsr__stg_core__condition
    config:
      tags:
        - ccsr
      materialized: ephemeral

  - name: ccsr__stg_core__procedure
    config:
      tags:
        - ccsr
      materialized: ephemeral