version: 2

models:

#### Final 
  - name: financial_pmpm__member_months
    description: Creates member months from eligibility data
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: member_months
      tags: 
        - financial_pmpm
      materialized: table
    columns:
      - name: patient_id
        description: Unique identifier for each patient in the dataset.
      - name: year_month
        description: Unique year-month of in the dataset computed from eligibility.
      - name: payer
        description: Name of the payer (i.e. health insurer) providing coverage.
      - name: plan
        description: Name of the plan (i.e. sub contract) providing coverage.
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.
      
  - name: financial_pmpm__pmpm_prep
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: pmpm_prep
      tags: 
        - financial_pmpm
      materialized: table
    tests:
       - unique:
           column_name: "(patient_id || '_' || year_month || '_' || plan)"
    description: >
      Computes all the paid and allowed statistics for every patient_id and year_month combination.  
    columns:
      - name: patient_id
        description: Unique identifier for each patient in the dataset.
      - name: year_month
        description: Unique year-month of in the dataset computed from eligibility.
      - name: payer
        description: Name of the payer (i.e. health insurer) providing coverage.
      - name: plan
        description: Name of the plan (i.e. sub contract) providing coverage.
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: inpatient_paid
        description: Total inpatient paid amount per member per month (PMPM).
      - name: outpatient_paid
        description: Total outpatient paid amount per member per month (PMPM).
      - name: office_visit_paid
        description: Total office visit paid amount per member per month (PMPM).
      - name: ancillary_paid
        description: Total ancillary paid amount per member per month (PMPM).
      - name: pharmacy_paid
        description: Total pharmacy paid amount per member per month (PMPM).
      - name: other_paid
        description: Total other paid amount per member per month (PMPM).
      - name: acute_inpatient_paid
        description: Total acute inpatient paid amount per member per month (PMPM).
      - name: ambulance_paid
        description: Total ambulance paid amount per member per month (PMPM).
      - name: ambulatory_surgery_paid
        description: Total ambulatory surgery paid amount per member per month (PMPM).
      - name: dialysis_paid
        description: Total dialysis paid amount per member per month (PMPM).
      - name: durable_medical_equipment_paid
        description: Total durable medical equipment paid amount per member per month (PMPM).
      - name: emergency_department_paid
        description: Total emergency department paid amount per member per month (PMPM).
      - name: home_health_paid
        description: Total home health paid amount per member per month (PMPM).
      - name: hospice_paid
        description: Total hospice paid amount per member per month (PMPM).
      - name: inpatient_psychiatric_paid
        description: Total inpatient psychiatric paid amount per member per month (PMPM).
      - name: inpatient_rehabilitation_paid
        description: Total inpatient rehabilitation paid amount per member per month (PMPM).
      - name: lab_paid
        description: Total lab paid amount per member per month (PMPM).
      - name: office_visit_paid_2
        description: Total office visit paid amount per member per month (PMPM).
      - name: outpatient_hospital_or_clinic_paid
        description: Total outpatient hospital or clinic paid amount per member per month (PMPM).
      - name: outpatient_psychiatric_paid
        description: Total outpatient psychiatric paid amount per member per month (PMPM).
      - name: outpatient_rehabilitation_paid
        description: Total outpatient rehabilitation paid amount per member per month (PMPM).
      - name: skilled_nursing_paid
        description: Total skilled nursing paid amount per member per month (PMPM).
      - name: urgent_care_paid
        description: Total urgent care paid amount per member per month (PMPM).
      - name: inpatient_allowed
        description: Total inpatient allowed amount per member per month (PMPM).
      - name: outpatient_allowed
        description: Total outpatient allowed amount per member per month (PMPM).
      - name: office_visit_allowed
        description: Total office visit allowed amount per member per month (PMPM).
      - name: ancillary_allowed
        description: Total ancillary allowed amount per member per month (PMPM).
      - name: pharmacy_allowed
        description: Total pharmacy allowed amount per member per month (PMPM).
      - name: other_allowed
        description: Total other allowed amount per member per month (PMPM).
      - name: acute_inpatient_allowed
        description: Total acute inpatient allowed amount per member per month (PMPM).
      - name: ambulance_allowed
        description: Total ambulance allowed amount per member per month (PMPM).
      - name: ambulatory_surgery_allowed
        description: Total ambulatory surgery allowed amount per member per month (PMPM).
      - name: dialysis_allowed
        description: Total dialysis allowed amount per member per month (PMPM).
      - name: durable_medical_equipment_allowed
        description: Total durable medical equipment allowed amount per member per month (PMPM).
      - name: emergency_department_allowed
        description: Total emergency department allowed amount per member per month (PMPM).
      - name: home_health_allowed
        description: Total home health allowed amount per member per month (PMPM).
      - name: hospice_allowed
        description: Total hospice allowed amount per member per month (PMPM).
      - name: inpatient_psychiatric_allowed
        description: Total inpatient psychiatric allowed amount per member per month (PMPM).
      - name: inpatient_rehabilitation_allowed
        description: Total inpatient rehabilitation allowed amount per member per month (PMPM).
      - name: lab_allowed
        description: Total lab allowed amount per member per month (PMPM).
      - name: office_visit_allowed_2
        description: Total office visit allowed amount per member per month (PMPM).
      - name: outpatient_hospital_or_clinic_allowed
        description: Total outpatient hospital or clinic allowed amount per member per month (PMPM).
      - name: outpatient_psychiatric_allowed
        description: Total outpatient psychiatric allowed amount per member per month (PMPM).
      - name: outpatient_rehabilitation_allowed
        description: Total outpatient rehabilitation allowed amount per member per month (PMPM).
      - name: skilled_nursing_allowed
        description: Total skilled nursing allowed amount per member per month (PMPM).
      - name: urgent_care_allowed
        description: Total urgent care allowed amount per member per month (PMPM).
      - name: total_paid
        description: Total paid amount per member per month (PMPM).
      - name: medical_paid
        description: Total medical paid amount per member per month (PMPM).
      - name: total_allowed
        description: Total allowed amount per member per month (PMPM).
      - name: medical_allowed
        description: Total medical allowed amount per member per month (PMPM).
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

  - name: financial_pmpm__pmpm
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: pmpm
      tags: 
        - financial_pmpm
      materialized: table
    description: >
      Computes per member per month statistics for every service category by aggregating across patients from pmpm_prep.
    columns:
      - name: year_month
        description: Unique year-month of in the dataset computed from eligibility.
      - name: payer
        description: Name of the payer (i.e. health insurer) providing coverage.
      - name: plan
        description: Name of the plan (i.e. sub contract) providing coverage.
      - name: data_source
        description: >
          User-configured field that indicates the data source (e.g. typically 
          named after the payer and state "BCBS Tennessee").
      - name: member_months
        description: The sum of member months.
      - name: total_paid
        description: Total paid amount per member per month (PMPM).
      - name: medical_paid
        description: Total medical paid amount per member per month (PMPM).
      - name: inpatient_paid
        description: Total inpatient paid amount per member per month (PMPM).
      - name: outpatient_paid
        description: Total outpatient paid amount per member per month (PMPM).
      - name: office_visit_paid
        description: Total office visit paid amount per member per month (PMPM).
      - name: ancillary_paid
        description: Total ancillary paid amount per member per month (PMPM).
      - name: pharmacy_paid
        description: Total pharmacy paid amount per member per month (PMPM).
      - name: other_paid
        description: Total other paid amount per member per month (PMPM).
      - name: acute_inpatient_paid
        description: Total acute inpatient paid amount per member per month (PMPM).
      - name: ambulance_paid
        description: Total ambulance paid amount per member per month (PMPM).
      - name: ambulatory_surgery_paid
        description: Total ambulatory surgery paid amount per member per month (PMPM).
      - name: dialysis_paid
        description: Total dialysis paid amount per member per month (PMPM).
      - name: durable_medical_equipment_paid
        description: Total durable medical equipment paid amount per member per month (PMPM).
      - name: emergency_department_paid
        description: Total emergency department paid amount per member per month (PMPM).
      - name: home_health_paid
        description: Total home health paid amount per member per month (PMPM).
      - name: hospice_paid
        description: Total hospice paid amount per member per month (PMPM).
      - name: inpatient_psychiatric_paid
        description: Total inpatient psychiatric paid amount per member per month (PMPM).
      - name: inpatient_rehabilitation_paid
        description: Total inpatient rehabilitation paid amount per member per month (PMPM).
      - name: lab_paid
        description: Total lab paid amount per member per month (PMPM).
      - name: office_visit_paid_2
        description: Total office visit paid amount per member per month (PMPM).
      - name: outpatient_hospital_or_clinic_paid
        description: Total outpatient hospital or clinic paid amount per member per month (PMPM).
      - name: outpatient_psychiatric_paid
        description: Total outpatient psychiatric paid amount per member per month (PMPM).
      - name: outpatient_rehabilitation_paid
        description: Total outpatient rehabilitation paid amount per member per month (PMPM).
      - name: skilled_nursing_paid
        description: Total skilled nursing paid amount per member per month (PMPM).
      - name: urgent_care_paid
        description: Total urgent care paid amount per member per month (PMPM).
      - name: total_allowed
        description: Total allowed amount per member per month (PMPM).
      - name: medical_allowed
        description: Total medical allowed amount per member per month (PMPM).
      - name: inpatient_allowed
        description: Total inpatient allowed amount per member per month (PMPM).
      - name: outpatient_allowed
        description: Total outpatient allowed amount per member per month (PMPM).
      - name: office_visit_allowed
        description: Total office visit allowed amount per member per month (PMPM).
      - name: ancillary_allowed
        description: Total ancillary allowed amount per member per month (PMPM).
      - name: pharmacy_allowed
        description: Total pharmacy allowed amount per member per month (PMPM).
      - name: other_allowed
        description: Total other allowed amount per member per month (PMPM).
      - name: acute_inpatient_allowed
        description: Total acute inpatient allowed amount per member per month (PMPM).
      - name: ambulance_allowed
        description: Total ambulance allowed amount per member per month (PMPM).
      - name: ambulatory_surgery_allowed
        description: Total ambulatory surgery allowed amount per member per month (PMPM).
      - name: dialysis_allowed
        description: Total dialysis allowed amount per member per month (PMPM).
      - name: durable_medical_equipment_allowed
        description: Total durable medical equipment allowed amount per member per month (PMPM).
      - name: emergency_department_allowed
        description: Total emergency department allowed amount per member per month (PMPM).
      - name: home_health_allowed
        description: Total home health allowed amount per member per month (PMPM).
      - name: hospice_allowed
        description: Total hospice allowed amount per member per month (PMPM).
      - name: inpatient_psychiatric_allowed
        description: Total inpatient psychiatric allowed amount per member per month (PMPM).
      - name: inpatient_rehabilitation_allowed
        description: Total inpatient rehabilitation allowed amount per member per month (PMPM).
      - name: lab_allowed
        description: Total lab allowed amount per member per month (PMPM).
      - name: office_visit_allowed_2
        description: Total office visit allowed amount per member per month (PMPM).
      - name: outpatient_hospital_or_clinic_allowed
        description: Total outpatient hospital or clinic allowed amount per member per month (PMPM).
      - name: outpatient_psychiatric_allowed
        description: Total outpatient psychiatric allowed amount per member per month (PMPM).
      - name: outpatient_rehabilitation_allowed
        description: Total outpatient rehabilitation allowed amount per member per month (PMPM).
      - name: skilled_nursing_allowed
        description: Total skilled nursing allowed amount per member per month (PMPM).
      - name: urgent_care_allowed
        description: Total urgent care allowed amount per member per month (PMPM).
      - name: tuva_last_run
        description: >
          The last time the data was refreshed.  Generated by 
          `dbt_utils.pretty_time` as the local time of the `dbt run` 
          environment.  Timezone is configurable via the `tuva_last_run` var.

#### Intermediate

  - name: financial_pmpm__patient_spend_with_service_categories
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: _int_patient_spend_with_service_categories
      tags: 
        - financial_pmpm
      materialized: table
    description: >
      Adds service categories to claims and sums paid and allowed amounts to the year-month level.

  - name: financial_pmpm__service_category_1_allowed_pivot
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: _int_service_category_1_allowed_pivot
      tags: 
        - financial_pmpm
      materialized: table
    description: >
      Pivots out allowed amounts into columns by service category level 1.

  - name: financial_pmpm__service_category_2_allowed_pivot
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: _int_service_category_2_allowed_pivot
      tags: 
        - financial_pmpm
      materialized: table
    description: >
      Pivots out allowed amounts into columns by service category level 2.

  - name: financial_pmpm__service_category_1_paid_pivot
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: _int_service_category_1_paid_pivot
      tags: 
        - financial_pmpm
      materialized: table
    description: >
      Pivots out paid amounts into columns by service category level 1.

  - name: financial_pmpm__service_category_2_paid_pivot
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_financial_pmpm
        {% else %}financial_pmpm{%- endif -%}
      alias: _int_service_category_2_paid_pivot
      tags: 
        - financial_pmpm
      materialized: table
    description: >
      Pivots out paid amounts into columns by service category level 2.

## Staging
  - name: financial_pmpm__stg_eligibility
    config:
      tags: 
        - financial_pmpm
      materialized: ephemeral

  - name: financial_pmpm__stg_medical_claim
    config:
      tags: financial_pmpm
      materialized: ephemeral

  - name: financial_pmpm__stg_pharmacy_claim
    config:
      tags: financial_pmpm
      materialized: ephemeral
