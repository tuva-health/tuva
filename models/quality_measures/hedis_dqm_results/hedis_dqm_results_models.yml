version: 2

models:

## Final
  - name: quality_measures__hedis_cql_engine_log
    description: |
      Final model with deduplicated CQL computations produced from external 
      source for HEDIS Digital Quality Measures (dQM).
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: hedis_cql_engine_log
      tags:
        - hedis
        - quality_measures
      materialized: table
    columns:
      - name: person_id
        description: '{{ doc("person_id") }}'
      - name: measure_id
        description: '{{ doc("hedis_measure_id") }}'
      - name: measure_name
        description: '{{ doc("hedis_measure_name") }}'
      - name: measure_version
        description: '{{ doc("hedis_measure_year") }}'
      - name: cql_concept_key
        description: '{{ doc("hedis_cql_key") }}'
      - name: cql_concept_value
        description: '{{ doc("hedis_cql_value") }}'
      - name: data_source
        description: '{{ doc("data_source") }}'
      - name: tuva_last_run
        description: '{{ doc("tuva_last_run") }}'

  - name: quality_measures__hedis_summary_counts
    description: |
      Final model with deduplicated quality measure results from external 
      source for HEDIS Digital Quality Measures (dQM). This model sums the 
      results on a data source/measure level.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: hedis_summary_counts
      tags:
        - hedis
        - quality_measures
      materialized: table
    columns:
      - name: measure_id
        description: '{{ doc("hedis_measure_id") }}'
        config:
          meta:
            terminology: https://thetuvaproject.com/value-sets/quality-measures#measures
      - name: measure_name
        description: '{{ doc("hedis_measure_name") }}'
        config:
          meta:
            terminology: https://thetuvaproject.com/value-sets/quality-measures#measures
      - name: measure_version
        description: '{{ doc("hedis_measure_year") }}'
        config:
          meta:
            terminology: https://thetuvaproject.com/value-sets/quality-measures#measures
      - name: performance_period_begin
        description: '{{ doc("period_start") }}'
      - name: performance_period_end
        description: '{{ doc("period_end") }}'
      - name: rate_1_denominator_sum
        description: '{{ doc("denominator") }}'
      - name: rate_1_numerator_sum
        description: '{{ doc("numerator") }}'
      - name: rate_1_exclusion_sum
        description: '{{ doc("exclusion") }}'
      - name: rate_1_performance_rate
        description: '{{ doc("performance_rate") }}'
      - name: rate_1_medicare_denominator_sum
        description: '{{ doc("denominator") }}'
      - name: rate_1_medicare_numerator_sum
        description: '{{ doc("numerator") }}'
      - name: rate_1_medicare_exclusion_sum
        description: '{{ doc("exclusion") }}'
      - name: rate_1_medicare_performance_rate
        description: '{{ doc("performance_rate") }}'
      - name: rate_2_denominator_sum
        description: '{{ doc("denominator") }}'
      - name: rate_2_numerator_sum
        description: '{{ doc("numerator") }}'
      - name: rate_2_exclusion_sum
        description: '{{ doc("exclusion") }}'
      - name: rate_2_performance_rate
        description: '{{ doc("performance_rate") }}'
      - name: rate_2_medicare_denominator_sum
        description: '{{ doc("denominator") }}'
      - name: rate_2_medicare_numerator_sum
        description: '{{ doc("numerator") }}'
      - name: rate_2_medicare_exclusion_sum
        description: '{{ doc("exclusion") }}'
      - name: rate_2_medicare_performance_rate
        description: '{{ doc("performance_rate") }}'
      - name: data_source
        description: '{{ doc("data_source") }}'
      - name: tuva_last_run
        description: '{{ doc("tuva_last_run") }}'

  - name: quality_measures__hedis_summary_long
    description: |
      Final model with deduplicated quality measure results from external 
      source for HEDIS Digital Quality Measures (dQM). Each row represents the 
      results per patient/measure. A null for the denominator
      indicates that the patient was not eligible for that measure.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: hedis_summary_long
      tags:
        - hedis
        - quality_measures
      materialized: table
    columns:
      - name: person_id
        description: '{{ doc("person_id") }}'
      - name: rate_1_denominator_flag
        description: '{{ doc("denominator") }}'
      - name: rate_1_numerator_flag
        description: '{{ doc("numerator") }}'
      - name: rate_1_exclusion_flag
        description: '{{ doc("exclusion") }}'
      - name: rate_1_medicare_denominator_flag
        description: '{{ doc("denominator") }}'
      - name: rate_1_medicare_exclusion_flag
        description: '{{ doc("exclusion") }}'
      - name: rate_1_performance_flag
        description: '{{ doc("performance_rate") }}'
      - name: rate_1_medicare_performance_flag
        description: '{{ doc("performance_rate") }}'
      - name: rate_2_denominator_flag
        description: '{{ doc("denominator") }}'
      - name: rate_2_numerator_flag
        description: '{{ doc("numerator") }}'
      - name: rate_2_exclusion_flag
        description: '{{ doc("exclusion") }}'
      - name: rate_2_medicare_denominator_flag
        description: '{{ doc("denominator") }}'
      - name: rate_2_medicare_exclusion_flag
        description: '{{ doc("exclusion") }}'
      - name: rate_2_performance_flag
        description: '{{ doc("performance_rate") }}'
      - name: rate_2_medicare_performance_flag
        description: '{{ doc("performance_rate") }}'
      - name: performance_period_begin
        description: '{{ doc("period_start") }}'
      - name: performance_period_end
        description: '{{ doc("period_end") }}'
      - name: measure_id
        description: '{{ doc("hedis_measure_id") }}'
        config:
          meta:
            terminology: https://thetuvaproject.com/value-sets/quality-measures#measures
      - name: measure_name
        description: '{{ doc("hedis_measure_name") }}'
        config:
          meta:
            terminology: https://thetuvaproject.com/value-sets/quality-measures#measures
      - name: measure_version
        description: '{{ doc("hedis_measure_year") }}'
        config:
          meta:
            terminology: https://thetuvaproject.com/value-sets/quality-measures#measures
      - name: data_source
        description: '{{ doc("data_source") }}'
      - name: tuva_last_run
        description: '{{ doc("tuva_last_run") }}'

## Intermediate
  - name: quality_measures__int_hedis_cql_engine_log
    description: |
      Intermediate model transforming CQL computations produced from external 
      source for HEDIS Digital Quality Measures (dQM). Adds row number to sort 
      rows from previous executions for the same measure, year, patient, and key.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: _int_hedis_cql_engine_log
      tags:
        - hedis
        - quality_measures
      materialized: table
    columns:
      - name: patient
        description: '{{ doc("person_id") }}'
      - name: measure
        description: '{{ doc("hedis_measure_name") }}'
      - name: measure_id
        description: '{{ doc("hedis_measure_id") }}'
      - name: measure_year
        description: '{{ doc("hedis_measure_year") }}'
      - name: cql_key
        description: '{{ doc("hedis_cql_key") }}'
      - name: cql_value
        description: '{{ doc("hedis_cql_value") }}'
      - name: data_source
        description: '{{ doc("data_source") }}'
      - name: file_name
        description: '{{ doc("file_name") }}'
      - name: file_date
        description: '{{ doc("ingest_datetime") }}'
      - name: row_num
        description: |
          Row number used to sort rows from previous executions for the
          same measure, year, patient, and key.

  - name: quality_measures__int_hedis_measure_report
    description: |
      Intermediate model transforming quality measure report data from external 
      source for HEDIS Digital Quality Measures (dQM). Adds row number to sort 
      rows from previous executions for the same measure and patient.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: _int_hedis_measure_report
      tags:
        - hedis
        - quality_measures
      materialized: table
    columns:
      - name: id
        description: '{{ doc("hedis_execution_id") }}'
      - name: measure
        description: '{{ doc("hedis_measure_name") }}'
      - name: measure_id
        description: '{{ doc("hedis_measure_id") }}'
      - name: measure_year
        description: '{{ doc("hedis_measure_year") }}'
      - name: status
        description: '{{ doc("hedis_status") }}'
      - name: type
        description: '{{ doc("hedis_type") }}'
      - name: period_start
        description: '{{ doc("period_start") }}'
      - name: period_end
        description: '{{ doc("period_end") }}'
      - name: patient
        description: '{{ doc("person_id") }}'
      - name: rate_1_id
        description: '{{ doc("hedis_rate_id") }}'
      - name: rate_1_population_type_0
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_0
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_1_population_type_1
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_1
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_1_population_type_2
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_2
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_1_population_type_3
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_3
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_1_population_type_4
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_4
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_1_population_type_5
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_5
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_1_population_type_6
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_1_population_count_6
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_id
        description: '{{ doc("hedis_rate_id") }}'
      - name: rate_2_population_type_0
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_0
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_population_type_1
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_1
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_population_type_2
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_2
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_population_type_3
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_3
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_population_type_4
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_4
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_population_type_5
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_5
        description: '{{ doc("hedis_population_count") }}'
      - name: rate_2_population_type_6
        description: '{{ doc("hedis_population_type") }}'
      - name: rate_2_population_count_6
        description: '{{ doc("hedis_population_count") }}'
      - name: data_source
        description: '{{ doc("data_source") }}'
      - name: file_name
        description: '{{ doc("file_name") }}'
      - name: file_date
        description: '{{ doc("ingest_datetime") }}'
      - name: row_num
        description: |
          Row number used to sort rows from previous executions for the
          same measure, year, and patient.

  - name: quality_measures__int_hedis_measure_normalize
    description: |
      Intermediate model transforming quality measure report data from external 
      source for HEDIS Digital Quality Measures (dQM). Normalizes rates.
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: _int_hedis_measure_normalize
      tags:
        - hedis
        - quality_measures
      materialized: table
    columns:
      - name: id
        description: '{{ doc("hedis_execution_id") }}'
      - name: measure
        description: '{{ doc("hedis_measure_name") }}'
      - name: measure_id
        description: '{{ doc("hedis_measure_id") }}'
      - name: measure_year
        description: '{{ doc("hedis_measure_year") }}'
      - name: status
        description: '{{ doc("hedis_status") }}'
      - name: type
        description: '{{ doc("hedis_type") }}'
      - name: period_start
        description: '{{ doc("period_start") }}'
      - name: period_end
        description: '{{ doc("period_end") }}'
      - name: patient
        description: '{{ doc("person_id") }}'
      - name: rate_1_initial_population_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "initial population".
      - name: rate_1_denominator_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "denominator".
      - name: rate_1_exclusion_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "exclusion".
      - name: rate_1_medicare_denominator_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "medicare denominator".
      - name: rate_1_medicare_exclusion_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "medicare exclusion".
      - name: rate_1_numerator_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "numerator".
      - name: rate_2_initial_population_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "initial population".
      - name: rate_2_denominator_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "denominator".
      - name: rate_2_exclusion_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "exclusion".
      - name: rate_2_medicare_denominator_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "medicare denominator".
      - name: rate_2_medicare_exclusion_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "medicare exclusion".
      - name: rate_2_numerator_flag
        description: |
          Normalized flag using population_type to map to the expected flag
          for measure concept "numerator".
      - name: rate_1_performance_flag
        description: '{{ doc("performance_flag") }}'
      - name: rate_1_medicare_performance_flag
        description: '{{ doc("performance_flag") }}'
      - name: rate_2_performance_flag
        description: '{{ doc("performance_flag") }}'
      - name: rate_2_medicare_performance_flag
        description: '{{ doc("performance_flag") }}'
      - name: data_source
        description: '{{ doc("data_source") }}'
      - name: file_name
        description: '{{ doc("file_name") }}'
      - name: file_date
        description: '{{ doc("ingest_datetime") }}'

## Staging
  - name: quality_measures__stg_hedis_cql_engine_log
    description: |
      Optional mart input. This table contains a detailed log of computations 
      of the CQL produced from external source for HEDIS Digital Quality 
      Measures (dQM).
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: _stg_hedis_cql_engine_log
      tags:
        - hedis
        - quality_measures
      materialized: view
      meta:
        columns:
          - name: measure
          - name: measure_year
          - name: patient
          - name: cql_key
          - name: cql_value
          - name: data_source
          - name: file_name
          - name: file_date

  - name: quality_measures__stg_hedis_measure_report
    description: |
      Optional mart input. This table contains quality measure report data from 
      HEDIS Digital Quality Measures (dQM).
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures{% else %}quality_measures{%- endif -%}
      alias: _stg_hedis_measure_report
      tags:
        - hedis
        - quality_measures
      materialized: view
      meta:
        columns:
          - name: id
          - name: measure
          - name: status
          - name: type
          - name: period_start
          - name: period_end
          - name: patient
          - name: rate_1_id
          - name: rate_1_population_type_0
          - name: rate_1_population_count_0
          - name: rate_1_population_type_1
          - name: rate_1_population_count_1
          - name: rate_1_population_type_2
          - name: rate_1_population_count_2
          - name: rate_1_population_type_3
          - name: rate_1_population_count_3
          - name: rate_1_population_type_4
          - name: rate_1_population_count_4
          - name: rate_1_population_type_5
          - name: rate_1_population_count_5
          - name: rate_1_population_type_6
          - name: rate_1_population_count_6
          - name: rate_2_id
          - name: rate_2_population_type_0
          - name: rate_2_population_count_0
          - name: rate_2_population_type_1
          - name: rate_2_population_count_1
          - name: rate_2_population_type_2
          - name: rate_2_population_count_2
          - name: rate_2_population_type_3
          - name: rate_2_population_count_3
          - name: rate_2_population_type_4
          - name: rate_2_population_count_4
          - name: rate_2_population_type_5
          - name: rate_2_population_count_5
          - name: rate_2_population_type_6
          - name: rate_2_population_count_6
          - name: data_source
          - name: file_name
          - name: file_date